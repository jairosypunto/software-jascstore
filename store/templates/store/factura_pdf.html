{% load humanize %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    /* üé® Estilos generales para el PDF */
    body {
      font-family: sans-serif;
      font-size: 12px;
      margin: 40px;
      color: #2c3e50;
    }
    h2, h3 { margin-bottom: 10px; }

    /* üì¶ Tabla de productos */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
    }
    td, th {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
      word-break: break-word;
      white-space: normal;
    }
    th {
      background-color: #f2f2f2;
      text-align: left;
    }

    /* üìê Columnas de la tabla */
    .col-producto { width: 55%; }
    .col-cantidad { width: 10%; text-align: center; white-space: nowrap; }
    .col-unitario { width: 20%; white-space: nowrap; }
    .col-subtotal { width: 15%; text-align: right; white-space: nowrap; }

    /* üé® Utilidades de texto */
    .text-right { text-align: right; }
    .text-muted { color: #888; font-size: 11px; }
    .text-danger { color: #c0392b; }
    .text-success { color: #27ae60; font-weight: bold; }

    /* üè∑Ô∏è Resumen de descuentos */
    .resumen-descuento {
      margin-top: 10px;
      font-size: 11px;
      color: #555;
    }
    .resumen-descuento strong {
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <!-- üßæ Encabezado de la factura -->
  <h2>üßæ Factura #{{ factura.id }} ‚Äì JascShop</h2>
  <p><strong>Cliente:</strong> {{ factura.usuario.first_name|default:factura.usuario.username }}</p>
  <p><strong>Email:</strong> {{ factura.usuario.email }}</p>
  <p><strong>Fecha:</strong> {{ fecha_local|date:"d/m/Y H:i" }}</p>

  <!-- üí≥ M√©todo de pago y banco -->
  <p><strong>M√©todo de pago:</strong> {{ factura.metodo_pago }}</p>
  <p><strong>Estado del pago:</strong>
    {% if factura.estado_pago == "Pendiente" %}
      <span class="text-danger">Pendiente</span>
    {% else %}
      <span class="text-success">Pagado</span>
    {% endif %}
  </p>
  {% if factura.banco %}
    <p><strong>Banco utilizado:</strong> {{ factura.banco }}</p>
  {% endif %}
  {% if factura.transaccion_id %}
    <p><strong>ID de transacci√≥n:</strong> {{ factura.transaccion_id }}</p>
  {% endif %}

  <!-- üì¶ Detalle de productos -->
  <h3>üõç Detalles del pedido:</h3>
  <table>
    <thead>
      <tr>
        <th class="col-producto">Producto</th>
        <th class="col-cantidad">Cantidad</th>
        <th class="col-unitario">Precio unitario</th>
        <th class="col-subtotal">Subtotal</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}
      <tr>
        <td class="col-producto">
          {{ item.producto.name }}
          <!-- üé® Variantes: talla y color -->
          {% if item.talla or item.color %}
            <div class="text-muted">
              {% if item.talla %}Talla: {{ item.talla }}{% endif %}
              {% if item.talla and item.color %} | {% endif %}
              {% if item.color %}Color: {{ item.color }}{% endif %}
            </div>
          {% endif %}
        </td>
        <td class="col-cantidad">{{ item.cantidad }}</td>
        <td class="col-unitario">
          ${{ item.precio_unitario|floatformat:0|intcomma }}
        </td>
        <td class="col-subtotal">
          ${{ item.subtotal|floatformat:0|intcomma }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- üè∑Ô∏è Resumen de descuentos por producto -->
  {% for item in items %}
    {% if item.producto.discount > 0 %}
      <div class="resumen-descuento">
        <strong>{{ item.producto.name }}</strong>: Antes ${{ item.producto.cost|floatformat:0|intcomma }}
        ({{ item.producto.discount }}% de descuento)
      </div>
    {% endif %}
  {% endfor %}

  <!-- üí∞ Totales -->
  <div class="text-right" style="margin-top: 20px;">
    <p><strong>Subtotal:</strong> ${{ subtotal|floatformat:0|intcomma }}</p>
    <p><strong>Ahorro total:</strong> ${{ descuento|floatformat:0|intcomma }}</p>
    <p><strong>Total pagado:</strong> <span class="text-success">${{ total_final|floatformat:0|intcomma }}</span></p>
    <p class="text-muted">El descuento ya fue aplicado en los precios unitarios. Esta l√≠nea refleja el ahorro total.</p>
  </div>

  <!-- üìå Nota final -->
  <p class="text-muted" style="margin-top: 30px;">
    Esta factura ha sido generada electr√≥nicamente por JascShop. V√°lida sin firma. Gracias por tu compra.
  </p>
</body>
</html>