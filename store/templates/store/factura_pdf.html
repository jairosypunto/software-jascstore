{% load humanize %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body { font-family: sans-serif; font-size: 12px; margin: 40px; color: #2c3e50; }
    h2, h3 { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
    td, th { border: 1px solid #ccc; padding: 6px; vertical-align: top; word-break: break-word; white-space: normal; }
    th { background-color: #f2f2f2; text-align: left; }
    .col-producto { width: 55%; }
    .col-cantidad { width: 10%; text-align: center; white-space: nowrap; }
    .col-unitario { width: 20%; white-space: nowrap; }
    .col-subtotal { width: 15%; text-align: right; white-space: nowrap; }
    .text-right { text-align: right; }
    .text-muted { color: #888; font-size: 11px; }
    .text-danger { color: #c0392b; }
    .text-success { color: #27ae60; font-weight: bold; }
    .text-warning { color: #e67e22; font-weight: bold; }
    .resumen-descuento { margin-top: 10px; font-size: 11px; color: #555; }
    .resumen-descuento strong { color: #2c3e50; }
    .btn-whatsapp {
      display: inline-block;
      background-color: #25D366;
      color: white;
      padding: 8px 14px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h2>üßæ Factura #{{ factura.id }} ‚Äì JascShop</h2>

  <h3>üì¶ Datos de env√≠o</h3>
  <p><strong>Nombre:</strong> {{ factura.nombre }}</p>
  <p><strong>Email:</strong> {{ factura.email }}</p>
  <p><strong>Tel√©fono:</strong> {{ factura.telefono }}</p>
  <p><strong>Direcci√≥n:</strong> {{ factura.direccion }}</p>
  <p><strong>Ciudad:</strong> {{ factura.ciudad }}</p>
  <p><strong>Departamento:</strong> {{ factura.departamento }}</p>

  <p><strong>Fecha:</strong> {{ fecha_local|date:"d/m/Y H:i" }}</p>
  <p><strong>M√©todo de pago:</strong> {{ factura.metodo_pago }}</p>
  <p><strong>Estado del pago:</strong>
    {% if estado_pago == "Pagado" and es_pago_real %}
      <span class="text-success">‚úÖ Pago Simulado</span>
    {% elif factura.estado_pago == "Pagado" %}
      <span class="text-warning">üü° Simulado</span>
    {% elif factura.estado_pago == "Pendiente" %}
      <span class="text-danger">üïí Pendiente</span>
    {% elif factura.estado_pago == "Fallido" %}
      <span class="text-danger">‚ùå Fallido</span>
    {% else %}
      <span class="text-muted">{{ factura.estado_pago }}</span>
    {% endif %}
  </p>
  {% if factura.banco %}
    <p><strong>Banco utilizado:</strong> {{ factura.banco }}</p>
  {% endif %}
  {% if factura.transaccion_id %}
    <p><strong>ID de transacci√≥n:</strong> {{ factura.transaccion_id }}</p>
  {% endif %}

  <h3>üõç Detalles del pedido:</h3>
  <table>
    <thead>
      <tr>
        <th class="col-producto">Producto</th>
        <th class="col-cantidad">Cantidad</th>
        <th class="col-unitario">Precio unitario</th>
        <th class="col-subtotal">Subtotal</th>
      </tr>
    </thead>
    <tbody>
      {% for item in items %}
      <tr>
        <td class="col-producto">
          {{ item.producto.name }}
          {% if item.talla or item.color %}
            <div class="text-muted">
              {% if item.talla %}Talla: {{ item.talla }}{% endif %}
              {% if item.talla and item.color %} | {% endif %}
              {% if item.color %}Color: {{ item.color }}{% endif %}
            </div>
          {% endif %}
        </td>
        <td class="col-cantidad">{{ item.cantidad }}</td>
        <td class="col-unitario">${{ item.precio_unitario|floatformat:0|intcomma }}</td>
        <td class="col-subtotal">${{ item.subtotal|floatformat:0|intcomma }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Mostrar solo referencia de descuentos, no recalcular -->
  {% for item in items %}
    {% if item.producto.discount > 0 %}
      <div class="resumen-descuento">
        <strong>{{ item.producto.name }}</strong>: Antes ${{ item.producto.cost|floatformat:0|intcomma }}
        ({{ item.producto.discount }}% de descuento aplicado)
      </div>
    {% endif %}
  {% endfor %}

  <!-- Resumen final -->
  <div class="text-right" style="margin-top: 20px;">
    <p><strong>Subtotal:</strong> ${{ subtotal|floatformat:0|intcomma }}</p>
    {% if iva > 0 %}
      <p><strong>IVA (19%):</strong> ${{ iva|floatformat:0|intcomma }}</p>
    {% endif %}
    <p><strong>Total:</strong> <span class="text-success">${{ total_final|floatformat:0|intcomma }}</span></p>
    <p class="text-muted">Los precios unitarios ya incluyen el descuento aplicado.</p>
  </div>

  <p style="margin-top:20px; text-align:center;">
    <a href="https://wa.me/573016173378?text=Hola%20quiero%20m√°s%20informaci√≥n%20sobre%20mi%20pedido%20{{ factura.id }}"
       class="btn-whatsapp" target="_blank">
       üí¨ Contactar por WhatsApp
    </a>
  </p>

  <p class="text-muted" style="margin-top: 30px;">
    Esta factura ha sido generada electr√≥nicamente por JascShop. V√°lida sin firma. Gracias por tu compra.
  </p>
</body>
</html>