{% load humanize %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      font-family: sans-serif;
      font-size: 12px;
      margin: 40px;
      color: #2c3e50;
    }
    h2, h3 { margin-bottom: 10px; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      table-layout: fixed;
    }

    td, th {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
      word-break: break-word;
      white-space: normal;
    }

    th {
      background-color: #f2f2f2;
      text-align: left;
    }

    .col-producto { width: 55%; }
    .col-cantidad { width: 10%; text-align: center; white-space: nowrap; }
    .col-unitario { width: 20%; white-space: nowrap; }
    .col-subtotal { width: 15%; text-align: right; white-space: nowrap; }

    .text-right { text-align: right; }
    .text-muted { color: #888; font-size: 11px; }
    .text-danger { color: #c0392b; }
    .text-success { color: #27ae60; font-weight: bold; }

    .resumen-descuento {
      margin-top: 10px;
      font-size: 11px;
      color: #555;
    }

    .resumen-descuento strong {
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <h2>üßæ Factura #{{ factura.id }} ‚Äì LatinShop</h2>
<p style="color:red; font-size:10px;">PLANTILLA ACTIVA V5</p>
  <p><strong>Cliente:</strong> {{ factura.usuario.first_name|default:factura.usuario.username }}</p>
  <p><strong>Email:</strong> {{ factura.usuario.email }}</p>
  <p><strong>Fecha:</strong> {{ fecha_local|date:"d/m/Y H:i" }}</p>
  <p><strong>M√©todo de pago:</strong> {{ factura.metodo_pago }}</p>
  <p><strong>Estado del pago:</strong>
    {% if factura.estado_pago == "Pendiente" %}
      <span class="text-danger">Pendiente</span>
    {% else %}
      <span class="text-success">Pagado</span>
    {% endif %}
  </p>
  {% if factura.banco %}
    <p><strong>Banco utilizado:</strong> {{ factura.banco }}</p>
  {% endif %}
  {% if factura.transaccion_id %}
    <p><strong>ID de transacci√≥n:</strong> {{ factura.transaccion_id }}</p>
  {% endif %}

  <h3>üõç Detalles del pedido:</h3>
  <table>
    <thead>
      <tr>
        <th class="col-producto">Producto</th>
        <th class="col-cantidad">Cantidad</th>
        <th class="col-unitario">Precio unitario</th>
        <th class="col-subtotal">Subtotal</th>
      </tr>
    </thead>
    <tbody>
      {% for item in factura.detalles.all %}
      <tr>
        <td class="col-producto">{{ item.producto.title }}</td>
        <td class="col-cantidad">{{ item.cantidad }}</td>
        <td class="col-unitario">
          ${{ item.producto.final_price|floatformat:0|intcomma }}
        </td>
        <td class="col-subtotal">
          ${{ item.subtotal|floatformat:0|intcomma }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% for item in factura.detalles.all %}
    {% if item.producto.discount > 0 %}
      <div class="resumen-descuento">
        <strong>{{ item.producto.title }}</strong>: Antes ${{ item.producto.cost|floatformat:0|intcomma }} ({{ item.producto.discount }}% de descuento)
      </div>
    {% endif %}
  {% endfor %}

  <div class="text-right" style="margin-top: 20px;">
    <p><strong>Subtotal:</strong> ${{ subtotal|floatformat:0|intcomma }}</p>
    <p><strong>IVA (19%):</strong> ${{ iva|floatformat:0|intcomma }}</p>
    <p><strong>Ahorro total:</strong> ${{ descuento|floatformat:0|intcomma }}</p>
    <p><strong>Total pagado:</strong> <span class="text-success">${{ total_final|floatformat:0|intcomma }}</span></p>
    <p class="text-muted">El descuento ya fue aplicado en los precios unitarios. Esta l√≠nea refleja el ahorro total.</p>
  </div>

  <p class="text-muted" style="margin-top: 30px;">
    Esta factura ha sido generada electr√≥nicamente por JascShop. V√°lida sin firma. Gracias por tu compra.
  </p>
</body>
</html>