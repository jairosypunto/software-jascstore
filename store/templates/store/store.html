{% extends 'base.html' %}
{% load static %}
{% load l10n %}
{% load humanize %}

{% block title %}Nuestra Tienda - JascStore{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'store/css/banner.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'store/css/store.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'store/css/estilos_productos_tienda.css' %}?v={{ STATIC_VERSION }}">

<style>

/* FORZAR HABILITACIÃ“N VISUAL */
.color-chip, .size-chip, .jasc-cart, .btn-agregar {
    cursor: pointer !important;
    pointer-events: auto !important;
    opacity: 1 !important;
}

.color-chip.seleccionado {
    border: 2px solid var(--azul-hermoso) !important;
    background-color: var(--azul-hermoso) !important;
    color: white !important;
}


    :root {
        --azul-premium: #1a237e;
        --azul-hermoso: #0f087e;
        --azul-acento: #3949ab;
        --blanco-puro: #ffffff;
    }

    /* ðŸ’Ž BANNER MEJORADO */
    .banner-caption h2 {
        font-weight: 800;
        font-size: 3rem;
        text-shadow: 0 4px 15px rgba(0,0,0,0.4);
    }

    .btn-premium-banner {
        background-color: var(--azul-hermoso);
        border: none;
        padding: 12px 30px;
        border-radius: 50px;
        transition: all 0.3s;
    }

    .btn-premium-banner:hover {
        background-color: var(--azul-acento);
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }

    /* ðŸ”Ž BARRA DE BÃšSQUEDA PROFESIONAL */
    .search-container-premium {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 25px rgba(26, 35, 126, 0.08);
        margin-top: -40px;
        position: relative;
        z-index: 100;
    }

    .form-control, .form-select {
        border: 1px solid #e0e0e0;
        padding: 12px;
        border-radius: 10px;
    }

    /* ðŸ‘Ÿ PRODUCT CARDS - ESTILO TEMU */
    .product-card {
        border: none !important;
        border-radius: 0 !important;
        transition: all 0.4s ease;
        background: transparent;
        overflow: hidden;
    }

    .product-image-wrapper {
        position: relative;
        background: #f8f9fa;
        aspect-ratio: 1/1;
        cursor: pointer;
        border-radius: 15px;
        overflow: hidden;
    }

    .product-img {
        mix-blend-mode: multiply;
        transition: transform 0.5s ease;
    }

    .product-card:hover .product-img {
        transform: scale(1.08);
    }

    /* ðŸ›’ BOTÃ“N CARRITO ESTILO TEMU (PEQUEÃ‘O Y AL LADO) */
    .price-action-container {
        display: flex;
        align-items: center;
        justify-content: space-between; /* Separa el precio del botÃ³n */
        margin-top: 8px;
        padding: 0 5px;
    }

    .jasc-cart {
        background: white !important;
        color: #333 !important;
        border: 1px solid #ddd !important;
        width: 38px !important; /* TamaÃ±o pequeÃ±o circular */
        height: 38px !important;
        border-radius: 50% !important;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        padding: 0 !important;
        flex-shrink: 0; /* Evita que se deforme */
    }

    .jasc-cart:hover {
        background: #f5f5f5 !important;
        border-color: var(--azul-hermoso) !important;
        color: var(--azul-hermoso) !important;
        transform: scale(1.1);
    }

    .jasc-cart i {
        font-size: 1.2rem;
    }

    /* ðŸ’¬ WHATSAPP PREMIUM */
    .btn-whatsapp {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #25D366;
        color: white;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 30px;
        box-shadow: 0 10px 25px rgba(37, 211, 102, 0.4);
        z-index: 1000;
        transition: all 0.3s;
    }
</style>
{% endblock %}

{% block banner_full %}
<div class="full-bleed">
  <div class="swiper bannerSwiper">
    <div class="swiper-wrapper">
      {% for banner in banners %}
      <div class="swiper-slide">
        <div class="banner-bg" style="background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.2)), url('{{ banner.image.url }}')"></div>
        <div class="banner-caption text-center">
          <span class="text-uppercase fw-bold mb-2 d-block" style="letter-spacing: 3px; color: #ffd700;">Exclusivo</span>
          <h2>{{ banner.title }}</h2>
          <p class="fs-5 opacity-75">{{ banner.subtitle }}</p>
          <a href="#productos" class="btn btn-premium-banner btn-lg text-white mt-3 shadow">
            Explorar ColecciÃ³n <i class="bi bi-arrow-right ms-2"></i>
          </a>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="swiper-pagination"></div>
  </div>
</div>
{% endblock %}

{% block content %}
<section class="shop-section py-4">
  <div class="container">

    {% if user.is_authenticated %}
    <div class="welcome-mobile-container d-md-none mb-3">
        <div class="welcome-mobile shadow-sm">
            <i class="bi bi-person-circle me-2"></i>
            Hola, <span class="fw-bold">{{ user.first_name|default:user.username }}</span> ðŸ‘‹
        </div>
    </div>
    {% endif %}

    <div class="search-container-premium mb-5">
        <form method="get" class="row g-2">
          <div class="col-lg-4 col-md-12">
            <div class="input-group">
                <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
                <input type="text" name="q" value="{{ search_query }}" placeholder="Buscar en la tienda..." class="form-control border-start-0">
            </div>
          </div>
          <div class="col-lg-3 col-md-4">
            <select name="category" class="form-select border-0 bg-light">
                <option value="all">Todas las categorÃ­as</option>
                {% for cat in categorias %}
                <option value="{{ cat.slug }}" {% if categoria_actual.slug == cat.slug %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
          </div>
          <div class="col-lg-3 col-md-4">
            <select name="order" class="form-select border-0 bg-light">
                <option value="">Ordenar por...</option>
                <option value="price" {% if order == 'price' %}selected{% endif %}>Menor Precio</option>
                <option value="price_desc" {% if order == 'price_desc' %}selected{% endif %}>Mayor Precio</option>
                <option value="recent" {% if order == 'recent' %}selected{% endif %}>Novedades</option>
            </select>
          </div>
          <div class="col-lg-2 col-md-4">
            <button class="btn btn-premium-banner w-100 text-white fw-bold">Filtrar</button>
          </div>
        </form>
    </div>

    <div class="d-flex align-items-center gap-3 mb-4">
        <h2 class="section-title mb-0 fw-bold" style="color: var(--azul-hermoso);">âœ¨ Destacados</h2>
        <div class="flex-grow-1 border-bottom" style="opacity: 0.1;"></div>
    </div>

    <div class="swiper destacados-swiper mb-5 pb-4">
      <div class="swiper-wrapper">
        {% for producto in productos_destacados %}
        <div class="swiper-slide">
          <div class="destacado-card border-0 shadow-none rounded-4 overflow-hidden bg-transparent">
            <div class="ratio ratio-1x1 mb-2">
                <img src="{{ producto.image.url }}" class="object-fit-cover rounded-4" alt="{{ producto.name }}">
            </div>
            <div class="p-2 text-center">
              <h5 class="fw-bold mb-1 text-truncate" style="font-size: 1rem;">{{ producto.name }}</h5>
              <span class="text-primary fw-bold">${{ producto.final_price|floatformat:0|intcomma }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <div class="d-flex align-items-center gap-3 mb-4">
        <h2 class="section-title mb-0 fw-bold" style="color: var(--azul-hermoso);">ðŸ›’ CatÃ¡logo Completo</h2>
        <div class="flex-grow-1 border-bottom" style="opacity: 0.1;"></div>
    </div>

    <div class="row g-4" id="productos">
      {% for product in productos %}
      <div class="col-6 col-md-4 col-lg-3">
        <article class="product-card h-100">
          
          <div class="product-image-wrapper" onclick="abrirVistaRapida('{{ product.id }}')">
            <img src="{{ product.image.url }}" class="product-img w-100" alt="{{ product.name }}">
            {% if product.discount > 0 %}
                <span class="badge bg-danger position-absolute top-0 end-0 m-2 shadow">-{{ product.discount }}%</span>
            {% endif %}
          </div>

          <div class="product-content pt-3 pb-2">
            <h3 class="h6 fw-bold text-dark text-truncate mb-1" style="text-align: left; padding: 0 5px;">{{ product.name }}</h3>
            
            <div class="price-action-container">
                <div class="price-box">
                  {% if product.discount > 0 %}
                    <span class="text-danger fw-bold fs-5">${{ product.final_price|floatformat:0|intcomma }}</span>
                    <small class="text-muted text-decoration-line-through d-block" style="font-size: 0.75rem;">${{ product.cost|floatformat:0|intcomma }}</small>
                  {% else %}
                    <span class="fw-bold fs-5 text-dark">${{ product.cost|floatformat:0|intcomma }}</span>
                  {% endif %}
                </div>

                <button type="button" 
                        class="jasc-cart" 
                        data-id="{{ product.id }}" 
                        data-has-variants="{{ product.has_variants|yesno:'true,false' }}"
                        onclick="abrirCarritoModal('{{ product.id }}')">
                    <i class="bi bi-cart-plus"></i>
                </button>
            </div>
          </div>

        </article>
      </div>
      {% endfor %}
    </div>

    <div class="vista-rapida-overlay hidden"></div>
    <div id="vistaRapidaPanel" class="vista-rapida-panel hidden">
      <button type="button" class="cerrar-panel">&times;</button>
      <div id="contenidoProducto"></div>
    </div>

  </div>
</section>

<a href="https://wa.me/573016173378?text=Hola!%20Vengo%20de%20la%20tienda%20y%20tengo%20una%20duda."
   class="btn-whatsapp shadow-lg" target="_blank">
   <i class="bi bi-whatsapp"></i>
</a>

<script>

  document.addEventListener('DOMContentLoaded', function() {
      // 1. FunciÃ³n de NormalizaciÃ³n
      const normalizarText = (t) => t ? t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";

      // 2. DELEGACIÃ“N DE EVENTOS GLOBAL
      document.addEventListener('click', function(e) {
          
          // --- DETECTAR CONTENEDOR ACTIVO (Vista RÃ¡pida o Carrito) ---
          // Buscamos el ancestro mÃ¡s cercano que sea uno de los dos modales
          const panel = e.target.closest('#vistaRapidaPanel') || e.target.closest('#carritoModal');
          if (!panel) return;

          // --- MANEJO DE CLIC EN COLOR ---
          const btnColor = e.target.closest('.color-chip');
          if (btnColor) {
              e.preventDefault();
              const colorSeleccionado = btnColor.dataset.value;

              // UI: Limpiar hermanos y marcar seleccionado con Azul Hermoso
              panel.querySelectorAll('.color-chip').forEach(b => {
                  b.classList.remove('selected', 'seleccionado');
                  b.style.backgroundColor = ""; // Reset de color previo
                  b.style.color = "";
              });
              
              btnColor.classList.add('selected', 'seleccionado');
              btnColor.style.backgroundColor = "#0f087e"; // Tu azul hermoso
              btnColor.style.color = "white";

              // Guardar en el hidden input del formulario (dentro del panel activo)
              const inputColor = panel.querySelector('#selected_color_hidden');
              if (inputColor) inputColor.value = colorSeleccionado;

              // --- LÃ“GICA DE CAMBIO DE IMAGEN ---
              const buscado = normalizarText(colorSeleccionado);
              const miniaturas = panel.querySelectorAll('.miniatura');
              const coincidencia = Array.from(miniaturas).find(m => normalizarText(m.dataset.color) === buscado);

              if (coincidencia) {
                  // Buscamos la imagen principal dentro del panel activo solamente
                  const imgPrincipal = panel.querySelector('#imagen-principal-modal') || panel.querySelector('#imagen-principal');
                  if (imgPrincipal) {
                      imgPrincipal.src = coincidencia.dataset.src;
                      
                      miniaturas.forEach(m => {
                          m.classList.remove('activa', 'activa-azul');
                          m.style.borderColor = "#ddd";
                      });
                      
                      coincidencia.classList.add('activa');
                      coincidencia.style.borderColor = "#0f087e";
                      
                      const inputImg = panel.querySelector('#imagen_seleccionada_url');
                      if (inputImg) inputImg.value = coincidencia.dataset.src;
                  }
              }
              
              validarEstadoModalUniversal(panel);
          }

          // --- MANEJO DE CLIC EN TALLA ---
          const btnTalla = e.target.closest('.size-chip');
          if (btnTalla) {
              e.preventDefault();
              panel.querySelectorAll('.size-chip').forEach(b => {
                  b.classList.remove('selected', 'seleccionado');
                  b.style.backgroundColor = "";
                  b.style.color = "";
              });
              
              btnTalla.classList.add('selected', 'seleccionado');
              btnTalla.style.backgroundColor = "#0f087e";
              btnTalla.style.color = "white";
              
              const inputTalla = panel.querySelector('#selected_size_hidden');
              if (inputTalla) inputTalla.value = btnTalla.dataset.value;
              
              validarEstadoModalUniversal(panel);
          }
      });
  });

  // FunciÃ³n auxiliar universal para habilitar/deshabilitar el botÃ³n de agregar
  function validarEstadoModalUniversal(panel) {
      if (!panel) return;

      // Buscamos el botÃ³n por ID o por clase dentro del panel
      const btn = panel.querySelector('#btnAgregarModalPropio') || panel.querySelector('#btnAgregarModal') || panel.querySelector('.btn-agregar');
      const valColor = panel.querySelector('#selected_color_hidden')?.value;
      const valTalla = panel.querySelector('#selected_size_hidden')?.value;
      
      const tieneColores = panel.querySelectorAll('.color-chip').length > 0;
      const tieneTallas = panel.querySelectorAll('.size-chip').length > 0;

      const colorOk = !tieneColores || (valColor && valColor !== "");
      const tallaOk = !tieneTallas || (valTalla && valTalla !== "");

      if (btn) {
          if (colorOk && tallaOk) {
              btn.disabled = false;
              btn.innerHTML = "ðŸ›’ AGREGAR AL CARRITO";
              btn.style.backgroundColor = "#0f087e";
              btn.style.opacity = "1";
          } else {
              btn.disabled = true;
              btn.style.backgroundColor = "#ccc";
              btn.style.opacity = "0.6";
              if (!colorOk) btn.innerHTML = "ðŸ›’ ELIGE COLOR";
              else if (!tallaOk) btn.innerHTML = "ðŸ›’ ELIGE TALLA";
          }
      }
  }

</script>

{% endblock %}
