{% extends 'base.html' %}
{% load static %}

{% block title %}Nuestra Tienda - JascShop{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'store/css/banner.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'store/css/store.css' %}?v={{ STATIC_VERSION }}">
  <link rel="stylesheet" href="{% static 'store/css/estilos_productos_tienda.css' %}?v={{ STATIC_VERSION }}">
{% endblock %}

{% block banner_full %}
<div class="full-bleed">
  <div class="bannerSwiper swiper">
    <div class="swiper-wrapper">
      {% for banner in banners %}
        <div class="swiper-slide">
          <div class="banner-bg" style="background-image: url('{{ banner.image.url }}');"></div>
          <div class="banner-caption">
            <h2>{{ banner.title }}</h2>
            <p>{{ banner.subtitle }}</p>
            <a href="#productos" class="btn btn-primary btn-lg mt-3">
              <i class="bi bi-bag"></i> Ver productos
            </a>
          </div>
        </div>
      {% endfor %}
    </div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>
{% endblock %}

{% block content %}
<section class="shop-section">
  <div class="shop-container">

    <!-- Buscador y filtros -->
    <form method="get" id="filterForm" class="search-form">
      <!-- buscador y filtros -->
    </form>

    <!-- Productos destacados -->
    <div class="swiper mySwiper">
      <div class="swiper-wrapper">
        {% for producto in productos_destacados %}
          <div class="swiper-slide">
            <img src="{{ producto.image.url }}" alt="{{ producto.name }}">
          </div>
        {% endfor %}
      </div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>

    <!-- Grid de productos -->
    <div class="products-grid" id="productos">
      {% for product in productos %}
        <article class="product-card">
          <div class="product-image-wrapper">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img">
            <a href="#" class="quick-view" data-id="{{ product.id }}" title="Vista r치pida">
              <i class="bi bi-eye"></i>
            </a>
          </div>

          <div class="product-content">
            <h3>{{ product.name }}</h3>
            <p>{{ product.description|truncatewords:12 }}</p>

            <!-- Opciones -->
            {% if product.sizes_list %}
              <div class="sizes">
                <label>Tallas:</label>
                {% for size in product.sizes_list %}
                  <button type="button" name="selected_size" value="{{ size }}" class="btn-option">{{ size }}</button>
                {% endfor %}
              </div>
            {% endif %}

            {% if product.colors_list %}
              <div class="colors">
                <label>Colores:</label>
                {% for color in product.colors_list %}
                  <button type="button" name="selected_color" value="{{ color }}" class="btn-option">{{ color }}</button>
                {% endfor %}
              </div>
            {% endif %}

            <!-- Precio -->
            {% if product.discount > 0 %}
              <p class="text-danger fw-bold">${{ product.final_price|floatformat:0 }}</p>
              <p class="text-muted text-decoration-line-through">${{ product.cost|floatformat:0 }}</p>
              <span class="badge bg-success">-{{ product.discount }}%</span>
            {% else %}
              <span class="price fw-bold">${{ product.cost|floatformat:0 }}</span>
            {% endif %}

            <!-- Bot칩n carrito -->
            <form method="POST" action="{% url 'store:agregar_al_carrito' product.id %}">
              {% csrf_token %}
              <input type="hidden" name="cantidad" value="1">
              <button type="submit" class="btn-cart-icon">
                <i class="bi bi-cart-plus"></i>
              </button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>

    <!-- Modal vista r치pida -->
    <div id="vistaRapidaModal" class="modal" style="display:none;">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="contenidoProducto"></div>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Swiper banners
  new Swiper(".bannerSwiper", {
    loop: true,
    autoplay: { delay: 5000 },
    pagination: { el: ".bannerSwiper .swiper-pagination", clickable: true },
    navigation: {
      nextEl: ".bannerSwiper .swiper-button-next",
      prevEl: ".bannerSwiper .swiper-button-prev"
    }
  });

  // Swiper destacados
  new Swiper(".mySwiper", {
    slidesPerView: 4,
    spaceBetween: 20,
    loop: true,
    autoplay: { delay: 3000 },
    navigation: {
      nextEl: ".mySwiper .swiper-button-next",
      prevEl: ".mySwiper .swiper-button-prev"
    }
  });

  // Vista r치pida con fetch
  document.querySelectorAll('.quick-view').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const id = this.dataset.id;
      fetch(`/store/vista-rapida/${id}/`)
        .then(res => res.text())
        .then(html => {
          const cont = document.getElementById('contenidoProducto');
          cont.innerHTML = html;                  // inserta HTML (los <script> internos NO ejecutan)
          document.getElementById('vistaRapidaModal').style.display = 'block';

          // Estado inicial seguro tras insertar contenido
          const img = cont.querySelector('#imagen-principal');
          const vc  = cont.querySelector('#video-contenedor');
          const vf  = cont.querySelector('#video-file');
          const ifr = cont.querySelector('#video-frame');

          if (img) { img.classList.add('visible'); img.classList.remove('hidden'); }
          if (vc)  { vc.classList.add('hidden'); vc.classList.remove('visible'); }
          if (vf)  { try { vf.pause(); } catch(e){} }
          if (ifr) { ifr.src = ''; }
        });
    });
  });

  // Cerrar modal
  const modal = document.getElementById('vistaRapidaModal');
  const closeBtn = modal.querySelector('.close');
  closeBtn.addEventListener('click', () => {
    // pausa y resetea video al cerrar para evitar audio fantasma
    const cont = document.getElementById('contenidoProducto');
    const vf  = cont.querySelector('#video-file');
    const ifr = cont.querySelector('#video-frame');
    const vc  = cont.querySelector('#video-contenedor');
    const img = cont.querySelector('#imagen-principal');

    if (vf) { try { vf.pause(); } catch(e){} }
    if (ifr) { ifr.src = ''; }
    if (vc)  { vc.classList.add('hidden'); vc.classList.remove('visible'); }
    if (img) { img.classList.add('visible'); img.classList.remove('hidden'); }

    modal.style.display = 'none';
  });

  window.addEventListener('click', e => {
    if (e.target === modal) {
      // mismo reset si se cierra por click fuera
      const cont = document.getElementById('contenidoProducto');
      const vf  = cont.querySelector('#video-file');
      const ifr = cont.querySelector('#video-frame');
      const vc  = cont.querySelector('#video-contenedor');
      const img = cont.querySelector('#imagen-principal');

      if (vf) { try { vf.pause(); } catch(e){} }
      if (ifr) { ifr.src = ''; }
      if (vc)  { vc.classList.add('hidden'); vc.classList.remove('visible'); }
      if (img) { img.classList.add('visible'); img.classList.remove('hidden'); }

      modal.style.display = 'none';
    }
  });
});

/* Funciones globales usadas por los onclick del HTML inyectado */
window.mostrarVideo = function(url, esArchivo) {
  const cont = document.getElementById('contenidoProducto');
  const img = cont.querySelector("#imagen-principal");
  const vc  = cont.querySelector("#video-contenedor");
  const vf  = cont.querySelector("#video-file");
  const vs  = cont.querySelector("#video-source");
  const ifr = cont.querySelector("#video-frame");

/* Debug */
console.log("游댌 mostrarVideo activado");
console.log("俱뫮잺 URL:", url);
console.log("俱뫮잺 esArchivo:", esArchivo);
console.log("游닍 contenedor:", vc);
console.log("游꿘 video file:", vf);
console.log("游깷 iframe:", ifr);
console.log("游늯 video source:", vs);

  // alterna visibilidad con clases
  if (img) { img.classList.add('hidden'); img.classList.remove('visible'); }
  if (vc)  { vc.classList.add('visible'); vc.classList.remove('hidden'); }

  if (esArchivo) {
    if (ifr) { ifr.src = ''; ifr.classList.add('hidden'); }
    if (vf && vs) {
      vs.src = url;
      vf.classList.add('visible');
      vf.classList.remove('hidden');
      vf.load();
      vf.onloadeddata = function() { try { vf.play(); } catch(e){} };
    }
  } else {
    if (vf) { try { vf.pause(); } catch(e){} vf.classList.add('hidden'); }
    if (ifr) { ifr.src = url; ifr.classList.add('visible'); ifr.classList.remove('hidden'); }
  }
};

window.mostrarImagen = function(url) {
  const cont = document.getElementById('contenidoProducto');
  const img = cont.querySelector("#imagen-principal");
  const vc  = cont.querySelector("#video-contenedor");
  const vf  = cont.querySelector("#video-file");
  const ifr = cont.querySelector("#video-frame");

  if (img) { img.src = url; img.classList.add('visible'); img.classList.remove('hidden'); }
  if (vc)  { vc.classList.add('hidden'); vc.classList.remove('visible'); }
  if (vf)  { try { vf.pause(); } catch(e){} vf.classList.add('hidden'); }
  if (ifr) { ifr.src = ''; ifr.classList.add('hidden'); }
};
</script>
{% endblock %}