{% extends 'base.html' %}
{% load static %}
{% load l10n %}

{% block title %}Nuestra Tienda - JascShop{% endblock %}

{% block extra_css %}
<!-- üé® ESTILOS DE LA TIENDA -->
<link rel="stylesheet" href="{% static 'store/css/banner.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'store/css/store.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'store/css/estilos_productos_tienda.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'store/css/vista_rapida.css' %}?v={{ STATIC_VERSION }}">
{% endblock %}

{% block banner_full %}
<!-- ==================================================
     üéØ BANNER PRINCIPAL (Swiper)
================================================== -->
<div class="full-bleed">
  <div class="swiper bannerSwiper">
    <div class="swiper-wrapper">
      {% for banner in banners %}
      <div class="swiper-slide">
        <div class="banner-bg"
             style="background-image:url('{% if banner.image %}{{ banner.image.url }}{% else %}{% static 'imgs/default-banner.jpg' %}{% endif %}')">
        </div>
        <div class="banner-caption">
          <h2>{{ banner.title }}</h2>
          <p>{{ banner.subtitle }}</p>
          <a href="#productos" class="btn btn-primary btn-lg mt-3">
            <i class="bi bi-bag"></i> Ver productos
          </a>
        </div>
      </div>
      {% endfor %}
    </div>
    <!-- Controles Swiper -->
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>
{% endblock %}

{% block content %}
<section class="shop-section">
  <div class="shop-container">

    <!-- ==================================================
         üîé FILTROS / B√öSQUEDA
    ================================================== -->
    <form method="get" class="search-form d-flex gap-2 mb-4">
      <input type="text"
             name="q"
             value="{{ search_query }}"
             placeholder="Buscar productos..."
             class="form-control">
      <select name="category" class="form-select">
        <option value="all">Todas las categor√≠as</option>
        {% for cat in categorias %}
        <option value="{{ cat.slug }}"
          {% if categoria_actual and categoria_actual.slug == cat.slug %}selected{% endif %}>
          {{ cat.name }}
        </option>
        {% endfor %}
      </select>
      <select name="order" class="form-select">
        <option value="">Ordenar por...</option>
        <option value="name" {% if order == 'name' %}selected{% endif %}>Nombre</option>
        <option value="price" {% if order == 'price' %}selected{% endif %}>Precio ‚Üë</option>
        <option value="price_desc" {% if order == 'price_desc' %}selected{% endif %}>Precio ‚Üì</option>
        <option value="recent" {% if order == 'recent' %}selected{% endif %}>Recientes</option>
      </select>
      <button class="btn btn-primary">Filtrar</button>
    </form>

    <!-- ==================================================
         ‚≠ê PRODUCTOS DESTACADOS (Swiper)
    ================================================== -->
    <h2 class="section-title">‚≠ê Productos destacados</h2>
    <div class="swiper mySwiper destacados-swiper">
      <div class="swiper-wrapper">
        {% for producto in productos_destacados %}
        <div class="swiper-slide">
          <div class="destacado-card">
            <img src="{% if producto.image %}{{ producto.image.url }}{% else %}{% static 'imgs/default-product.jpg' %}{% endif %}"
                 alt="{{ producto.name }}">
            <div class="destacado-info">
              <h4>{{ producto.name }}</h4>
              <span>${{ producto.final_price|floatformat:2|localize }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      <!-- Controles Swiper -->
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>
    
    <!-- ==================================================
         üõç GRID DE PRODUCTOS (CAT√ÅLOGO)
    ================================================== -->
    <div class="products-grid" id="productos">
      {% for product in productos %}
      <article class="product-card">
        <!-- üì∏ IMAGEN (con soporte hover de video) -->
        <div class="product-image-wrapper"
             {% if product.video_file %}
             data-video-src="{{ product.video_file.url }}"
             {% if product.video_thumb %}data-video-poster="{{ product.video_thumb.url }}"{% endif %}
             {% elif product.video_url %}
             data-video-src="{{ product.video_url }}"
             {% if product.video_thumb %}data-video-poster="{{ product.video_thumb.url }}"{% endif %}
             {% endif %}>
          <img src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'imgs/default-product.jpg' %}{% endif %}"
               class="product-img"
               alt="{{ product.name }}">
          <!-- üëÅ VISTA R√ÅPIDA -->
          <button type="button"
                  class="quick-view jasc-quick-view"
                  data-id="{{ product.id }}"
                  title="Vista r√°pida">
            <i class="bi bi-eye"></i>
          </button>
          <!-- üõí AGREGAR AL CARRITO -->
          <button type="button"
                  class="jasc-cart"
                  data-id="{{ product.id }}"
                  data-has-variants="{% if product.has_variants %}true{% else %}false{% endif %}"
                  title="Agregar al carrito">
            <i class="bi bi-cart-plus"></i>
          </button>
          {% if product.discount > 0 %}
            <span class="badge badge-descuento">-{{ product.discount }}%</span>
          {% endif %}
        </div>
        <!-- ‚ÑπÔ∏è INFO -->
        <div class="product-content">
          <h3 class="product-title text-truncate">{{ product.name }}</h3>
          <p class="product-description">
            {{ product.description|truncatewords:12 }}
          </p>
          {% if product.discount > 0 %}
            <p class="text-danger fw-bold">
              ${{ product.final_price|floatformat:2|localize }}
            </p>
            <small class="text-decoration-line-through">
              ${{ product.cost|floatformat:2|localize }}
            </small>
          {% else %}
            <span class="fw-bold">
              ${{ product.cost|floatformat:2|localize }}
            </span>
          {% endif %}
        </div>
      </article>
      {% endfor %}
    </div>

    <!-- ==================================================
         üß† MODAL VISTA R√ÅPIDA
    ================================================== -->
    <div class="vista-rapida-overlay hidden"></div>
    <div id="vistaRapidaPanel" class="vista-rapida-panel hidden" role="dialog" aria-modal="true" aria-label="Vista r√°pida">
      <button type="button" class="cerrar-panel" title="Cerrar" aria-label="Cerrar">&times;</button>
      <div id="contenidoProducto"></div>
    </div>

    <!-- ==================================================
         üõí MODAL DE CARRITO
    ================================================== -->
    <div class="carrito-overlay hidden"></div>
    <div id="carritoModal" class="carrito-panel hidden" role="dialog" aria-modal="true" aria-label="Seleccionar opciones">
      <button type="button" class="cerrar-carrito" title="Cerrar">&times;</button>
      <!-- Aqu√≠ se inyecta vista_carrito.html -->
      <div id="contenidoCarrito"></div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_js %}
<!-- üß† L√ìGICA DE TIENDA -->
<script src="{% static 'js/store.js' %}?v={{ STATIC_VERSION }}"></script>
{% endblock %}