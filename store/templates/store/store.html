{% extends 'base.html' %}
{% load static %}

{% block title %}Nuestra Tienda - LatinShop{% endblock %}

{% block extra_css %}
  <!-- üé® Estilos espec√≠ficos de la tienda -->
  <link rel="stylesheet" href="{% static 'store/css/banner.css' %}">
  <link rel="stylesheet" href="{% static 'store/css/store.css' %}">
  <link rel="stylesheet" href="{% static 'store/css/estilos_productos_tienda.css' %}">
{% endblock %}

{% block banner_full %}
<!-- üñºÔ∏è Banner principal con Swiper -->
<div class="full-bleed">
  <div class="bannerSwiper swiper">
    <div class="swiper-wrapper">
      {% if banners and banners.count %}
        {% for banner in banners %}
          <div class="swiper-slide">
            <!-- Fondo din√°mico del banner -->
            <div class="banner-bg" style="background-image: url('{{ banner.image.url }}');"></div>
            <div class="banner-caption">
              <h2>{{ banner.title }}</h2>
              <p>{{ banner.subtitle }}</p>
              <a href="#productos" class="btn btn-primary btn-lg mt-3">
                <i class="bi bi-bag"></i> Ver productos
              </a>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <!-- Banner de respaldo -->
        <div class="swiper-slide">
          <img src="{% static 'store/img/fallback-banner.jpg' %}" alt="LatinShop">
          <div class="banner-caption">
            <h2>Bienvenido a LatinShop</h2>
            <p>Especialistas en nuevos productos</p>
            <a href="#productos" class="btn btn-primary btn-lg mt-3">
              <i class="bi bi-bag"></i> Ver productos
            </a>
          </div>
        </div>
      {% endif %}
    </div>
    <!-- Controles del slider -->
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>
{% endblock %}

{% block content %}
<section class="shop-section">
  <div class="shop-container">

    <!-- üîç Buscador y filtros -->
    <form method="get" id="filterForm" class="search-form">
      <div class="shop-controls">
        <div class="controls-row">
          <!-- Campo de b√∫squeda -->
          <div class="search-box" id="searchBox">
            <input type="text" name="q" class="search-input" id="searchInput" placeholder="Buscar productos...">
            <button type="submit" class="search-icon" id="searchIcon" aria-label="Buscar">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                   class="bi bi-search" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 
                1.415-1.414l-3.85-3.85zm-5.242.656a5.5 5.5 0 1 1 
                0-11 5.5 5.5 0 0 1 0 11z"/>
              </svg>
            </button>
          </div>

          <!-- Filtros de categor√≠a y orden -->
          <div class="filter-group">
            <select name="category" class="filter-select" id="categoryFilter" onchange="this.form.submit()">
              <option value="all">Todas las categor√≠as</option>
              {% for categoria in categorias %}
                <option value="{{ categoria.slug }}" {% if categoria_actual == categoria %}selected{% endif %}>
                  {{ categoria.name }}
                </option>
              {% endfor %}
            </select>

            <select name="order" class="filter-select" id="sortFilter" onchange="this.form.submit()">
              <option value="">Ordenar por</option>
              <option value="name" {% if request.GET.order == 'name' %}selected{% endif %}>Nombre: A-Z</option>
              <option value="price" {% if request.GET.order == 'price' %}selected{% endif %}>Precio: Menor a Mayor</option>
              <option value="price_desc" {% if request.GET.order == 'price_desc' %}selected{% endif %}>Precio: Mayor a Menor</option>
              <option value="recent" {% if request.GET.order == 'recent' %}selected{% endif %}>M√°s recientes</option>
            </select>
          </div>
        </div>
      </div>
    </form>

    <!-- üåü Productos destacados -->
    <div class="swiper mySwiper">
      <div class="swiper-wrapper">
        {% for producto in productos_destacados %}
          <div class="swiper-slide">
            <img src="{{ producto.image.url }}" alt="{{ producto.name }}">
          </div>
        {% endfor %}
      </div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>

    <!-- üì¶ Contador de productos -->
    <div class="products-count">
      <p>Mostrando <strong>{{ productos.count }}</strong> productos</p>
    </div>
    <!-- üõçÔ∏è Grid de productos -->
    <div class="products-grid" id="productos">
      {% for product in productos %}
        <article class="product-card {% if not product.is_available %}out-of-stock{% endif %}">
<!-- üñºÔ∏è Imagen del producto con vista r√°pida mejorada -->
<div class="product-image-wrapper">
  <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img">

  <!-- üè∑Ô∏è Badges de estado del producto -->
            <div class="product-badges">
              {% if not product.is_available %}
                <span class="badge badge-unavailable">Agotado</span>
              {% elif product.stock < 5 %}
                <span class="badge badge-low-stock">¬°√öltimas unidades!</span>
              {% endif %}
              {% if product.date_register|timesince < "7 days" %}
                <span class="badge badge-new">Nuevo</span>
              {% endif %}
            </div>

            <!-- üìä Datos clave en hover: precio, stock, rating -->
            <div class="quick-info">
              <p class="mb-1 fw-bold text-white">${{ product.final_price|floatformat:0 }}</p>
              <p class="mb-1 text-white">Stock: {{ product.stock }}</p>
              <p class="mb-0 text-warning">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</p>
            </div>
              <!-- üîç Bot√≥n vista r√°pida funcional -->
<a href="#" class="quick-view" data-id="{{ product.id }}" title="Vista r√°pida">
  <i class="bi bi-eye"></i>
</a>
          </div>

          <!-- Contenido del producto -->
          <div class="product-content">
            <span class="product-category">{{ product.category.name }}</span>
            <h3 class="product-name"><a href="#">{{ product.name }}</a></h3>
            <p class="product-description">{{ product.description|truncatewords:12 }}</p>

            <!-- Precios y bot√≥n -->
            <div class="product-footer">
              <div class="price-section">
                {% if product.discount > 0 %}
                  <p class="text-danger fw-bold mb-1">${{ product.final_price|floatformat:0 }}</p>
                  <p class="text-muted text-decoration-line-through mb-1">${{ product.cost|floatformat:0 }}</p>
                  <span class="badge bg-success">-{{ product.discount }}%</span>
                {% else %}
                  <span class="price fw-bold">${{ product.cost|floatformat:0 }}</span>
                {% endif %}
              </div>

              {% if product.is_available and product.stock > 0 %}
                <form method="POST" action="{% url 'store:agregar_al_carrito' product.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn-cart-icon" title="Agregar al carrito">
                    <i class="bi bi-cart-plus"></i>
                  </button>
                </form>
              {% else %}
                <button class="btn-cart-icon btn-disabled" disabled title="No disponible">
                  <i class="bi bi-cart-x"></i>
                </button>
              {% endif %}
            </div>
          </div>
        </article>
      {% empty %}
        <!-- Mensaje si no hay productos -->
        <div class="no-products text-center p-4 border rounded shadow-sm bg-light">
          {% if request.GET.q %}
            <h4 class="text-danger mb-2">üîç No se encontraron resultados para ‚Äú{{ request.GET.q }}‚Äù</h4>
            <p class="text-muted">Verifica la ortograf√≠a o intenta con otra palabra clave.</p>
          {% else %}
            <h4 class="text-primary mb-2">üì¶ No hay productos disponibles</h4>
            <p class="text-muted">Explora otras categor√≠as o vuelve m√°s tarde.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>
<!-- ü™ü Modal √∫nico para Vista R√°pida -->
<div id="vistaRapidaModal" class="modal">
  <div class="modal-content">
    <!-- ‚ùå Bot√≥n cerrar -->
    <span class="close">&times;</span>
    <!-- üì¶ Contenido din√°mico del producto cargado v√≠a JS -->
    <div id="contenidoProducto"></div>
  </div>
</div>

    <!-- üìë Paginaci√≥n -->
    {% if productos.has_other_pages %}
      <div class="pagination">
        <!-- Bot√≥n anterior -->
        {% if productos.has_previous %}
          <a href="?page={{ productos.previous_page_number }}" class="pagination-btn">Anterior</a>
        {% endif %}

        <!-- N√∫meros de p√°gina -->
        <div class="pagination-numbers">
          {% for num in productos.paginator.page_range %}
            {% if productos.number == num %}
              <span class="pagination-number active">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}" class="pagination-number">{{ num }}</a>
            {% endif %}
          {% endfor %}
        </div>

        <!-- Bot√≥n siguiente -->
        {% if productos.has_next %}
          <a href="?page={{ productos.next_page_number }}" class="pagination-btn">Siguiente</a>
        {% endif %}
      </div>
    {% endif %}

  </div> <!-- cierre shop-container -->
</section>
{% endblock %}
  
{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // üéûÔ∏è Banner principal con Swiper
  new Swiper(".bannerSwiper", {
    loop: true,
    autoplay: { delay: 5000, disableOnInteraction: false },
    pagination: { el: ".bannerSwiper .swiper-pagination", clickable: true },
    navigation: {
      nextEl: ".bannerSwiper .swiper-button-next",
      prevEl: ".bannerSwiper .swiper-button-prev"
    },
    effect: "fade",
    fadeEffect: { crossFade: true },
    speed: 800
  });

  // üõçÔ∏è Carrusel de productos destacados
  new Swiper(".mySwiper", {
    slidesPerView: 4,
    spaceBetween: 20,
    loop: true,
    autoplay: { delay: 3000, disableOnInteraction: false },
    navigation: {
      nextEl: ".mySwiper .swiper-button-next",
      prevEl: ".mySwiper .swiper-button-prev"
    },
    breakpoints: {
      1024: { slidesPerView: 4 },
      768: { slidesPerView: 2 },
      480: { slidesPerView: 1 }
    }
  });

  // üîç Lupa como √≠cono dentro del input de b√∫squeda
  const searchInput = document.getElementById("searchInput");
  const searchBox = document.getElementById("searchBox");
  const searchIcon = document.getElementById("searchIcon");
  const filterForm = document.getElementById("filterForm");

  if (searchInput && searchBox && searchIcon && filterForm) {
    const toggleSearchState = () => {
      const hasText = searchInput.value.trim().length > 0;
      searchBox.classList.toggle("active", hasText);
    };

    toggleSearchState(); // inicial
    searchInput.addEventListener("input", toggleSearchState);

    searchIcon.addEventListener("click", () => {
      if (searchInput.value.trim()) {
        filterForm.submit();
      }
    });
  }

  // üëÅÔ∏è Vista r√°pida de producto con carga din√°mica
  document.querySelectorAll('.quick-view').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const id = this.dataset.id;
      if (!id) return;

      fetch(`/store/vista-rapida/${id}/`)
        .then(res => res.text())
        .then(html => {
          document.getElementById('contenidoProducto').innerHTML = html;
          document.getElementById('vistaRapidaModal').style.display = 'block';
        })
        .catch(() => {
          document.getElementById('contenidoProducto').innerHTML = '<p class="text-danger">Error al cargar el producto.</p>';
          document.getElementById('vistaRapidaModal').style.display = 'block';
        });
    });
  });

  // ‚ùå Cierre del modal
  const modal = document.getElementById('vistaRapidaModal');
  if (modal) {
    const closeBtn = modal.querySelector('.close');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        document.getElementById('contenidoProducto').innerHTML = '';
      });
    }

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        modal.style.display = 'none';
        document.getElementById('contenidoProducto').innerHTML = '';
      }
    });

    window.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
        document.getElementById('contenidoProducto').innerHTML = '';
      }
    });
  }

  // üî¢ Control de cantidad con botones + y -
  const cantidadInput = document.getElementById('cantidad');
  if (cantidadInput) {
    const min = parseInt(cantidadInput.min || '1', 10);
    const max = parseInt(cantidadInput.max || '999999', 10);

    document.querySelectorAll('.qty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const action = btn.dataset.action;
        let value = parseInt(cantidadInput.value || '1', 10);

        if (action === 'decrease') {
          value = Math.max(min, value - 1);
        }
        if (action === 'increase') {
          value = Math.min(max, value + 1);
        }

        cantidadInput.value = value;
      });
    });

    cantidadInput.addEventListener('input', () => {
      let value = cantidadInput.value.replace(/\D/g, '');
      if (value === '') value = String(min);
      value = Math.max(min, Math.min(max, parseInt(value, 10)));
      cantidadInput.value = value;
    });
  }
});
</script>
{% endblock %}