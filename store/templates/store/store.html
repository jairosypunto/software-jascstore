{% extends 'base.html' %}
{% load static %}

{% block title %}Nuestra Tienda - LatinShop{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'store/css/banner.css' %}">
  <link rel="stylesheet" href="{% static 'store/css/store.css' %}">
  <link rel="stylesheet" href="{% static 'store/css/estilos_productos_tienda.css' %}">
{% endblock %}

{% block banner_full %}
<div class="full-bleed">
  <div class="bannerSwiper swiper">
    <div class="swiper-wrapper">
      {% if banners and banners.count %}
        {% for banner in banners %}
          <div class="swiper-slide">
            <div class="banner-bg" style="background-image: url('{{ banner.image.url }}');"></div>
            <div class="banner-caption">
              <h2>{{ banner.title }}</h2>
              <p>{{ banner.subtitle }}</p>
              <a href="#productos" class="btn btn-primary btn-lg mt-3">
                <i class="bi bi-bag"></i> Ver productos
              </a>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="swiper-slide">
          <img src="{% static 'store/img/fallback-banner.jpg' %}" alt="LatinShop">
          <div class="banner-caption">
            <h2>Bienvenido a LatinShop</h2>
            <p>Especialistas en nuevos productos</p>
            <a href="#productos" class="btn btn-primary btn-lg mt-3">
              <i class="bi bi-bag"></i> Ver productos
            </a>
          </div>
        </div>
      {% endif %}
    </div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
    <div class="swiper-pagination"></div>
  </div>
</div>
{% endblock %}

{% block content %}
<section class="shop-section">
  <div class="shop-container">

    <!-- üîç Buscador -->
  <form method="get" id="filterForm" class="search-form">
  <div class="shop-controls">

    <!-- üîç Buscador -->
    <div class="search-box" id="searchBox">
      <input type="text" name="q" class="search-input" id="searchInput" placeholder="Buscar productos...">
      <button type="submit" class="search-icon" id="searchIcon" aria-label="Buscar">
        <!-- SVG directo de Bootstrap Icons -->
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
             class="bi bi-search" viewBox="0 0 16 16">
          <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 
          1.415-1.414l-3.85-3.85zm-5.242.656a5.5 5.5 0 1 1 
          0-11 5.5 5.5 0 0 1 0 11z"/>
        </svg>
      </button>
    </div>

    <!-- üìÇ Filtros -->
    <div class="filter-group">
      <select name="category" class="filter-select" id="categoryFilter" onchange="this.form.submit()">
        <option value="all">Todas las categor√≠as</option>
        {% for categoria in categorias %}
          <option value="{{ categoria.slug }}" {% if categoria_actual == categoria %}selected{% endif %}>
            {{ categoria.name }}
          </option>
        {% endfor %}
      </select>

      <select name="order" class="filter-select" id="sortFilter" onchange="this.form.submit()">
        <option value="">Ordenar por</option>
        <option value="name" {% if request.GET.order == 'name' %}selected{% endif %}>Nombre: A-Z</option>
        <option value="price" {% if request.GET.order == 'price' %}selected{% endif %}>Precio: Menor a Mayor</option>
        <option value="price_desc" {% if request.GET.order == 'price_desc' %}selected{% endif %}>Precio: Mayor a Menor</option>
        <option value="recent" {% if request.GET.order == 'recent' %}selected{% endif %}>M√°s recientes</option>
      </select>
    </div>

  </div>
</form>

    <!-- üè™ Destacados -->
    <div class="swiper mySwiper">
      <div class="swiper-wrapper">
        {% for producto in productos_destacados %}
          <div class="swiper-slide">
            <img src="{{ producto.image.url }}" alt="{{ producto.name }}">
          </div>
        {% endfor %}
      </div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>

    <!-- üì¶ Contador -->
    <div class="products-count">
      <p>Mostrando <strong>{{ productos.count }}</strong> productos</p>
    </div>

    <!-- üõçÔ∏è Grid -->
    <div class="products-grid" id="productos">
      {% for product in productos %}
        <article class="product-card {% if not product.is_available %}out-of-stock{% endif %}">
          <div class="product-image-wrapper">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-img">
            <div class="product-badges">
              {% if not product.is_available %}
                <span class="badge badge-unavailable">Agotado</span>
              {% elif product.stock < 5 %}
                <span class="badge badge-low-stock">¬°√öltimas unidades!</span>
              {% endif %}
              {% if product.date_register|timesince < "7 days" %}
                <span class="badge badge-new">Nuevo</span>
              {% endif %}
            </div>
            <a href="#" class="quick-view" title="Vista r√°pida">
              <i class="bi bi-eye"></i> <span>Vista r√°pida</span>
            </a>
          </div>

          <div class="product-content">
            <span class="product-category">{{ product.category.name }}</span>
            <h3 class="product-name"><a href="#">{{ product.name }}</a></h3>
            <p class="product-description">{{ product.description|truncatewords:12 }}</p>

            <div class="product-footer">
              <div class="price-section">
                {% if product.discount > 0 %}
                  <p class="text-danger fw-bold mb-1">Precio con descuento: ${{ product.final_price|floatformat:0 }}</p>
                  <p class="text-muted text-decoration-line-through mb-1">Precio original: ${{ product.cost|floatformat:0 }}</p>
                  <span class="badge bg-success">-{{ product.discount }}%</span>
                {% else %}
                  <span class="price fw-bold">${{ product.cost|floatformat:0 }}</span>
                {% endif %}
              </div>

              {% if product.is_available and product.stock > 0 %}
                <form method="POST" action="{% url 'store:agregar_al_carrito' product.id %}" class="add-to-cart-form">
                  {% csrf_token %}
                  <button type="submit" class="btn-add-cart">
                    <i class="bi bi-cart-plus"></i> <span>Agregar</span>
                  </button>
                </form>
              {% else %}
                <button class="btn-add-cart btn-disabled" disabled><span>No disponible</span></button>
              {% endif %}
            </div>
          </div>
        </article>
      {% empty %}
        <div class="no-products text-center p-4 border rounded shadow-sm bg-light">
          {% if request.GET.q %}
            <h4 class="text-danger mb-2">üîç No se encontraron resultados para ‚Äú{{ request.GET.q }}‚Äù</h4>
            <p class="text-muted">Verifica la ortograf√≠a o intenta con otra palabra clave.</p>
          {% else %}
            <h4 class="text-primary mb-2">üì¶ No hay productos disponibles</h4>
            <p class="text-muted">Explora otras categor√≠as o vuelve m√°s tarde.</p>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    {% if productos.has_other_pages %}
      <div class="pagination">
        {% if productos.has_previous %}
          <a href="?page={{ productos.previous_page_number }}" class="pagination-btn">Anterior</a>
        {% endif %}
        <div class="pagination-numbers">
          {% for num in productos.paginator.page_range %}
            {% if productos.number == num %}
              <span class="pagination-number active">{{ num }}</span>
            {% else %}
              <a href="?page={{ num }}" class="pagination-number">{{ num }}</a>
            {% endif %}
          {% endfor %}
        </div>
        {% if productos.has_next %}
          <a href="?page={{ productos.next_page_number }}" class="pagination-btn">Siguiente</a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Banner principal
  new Swiper(".bannerSwiper", {
    loop: true,
    autoplay: {
      delay: 5000,
      disableOnInteraction: false
    },
    pagination: {
      el: ".bannerSwiper .swiper-pagination",
      clickable: true
    },
    navigation: {
      nextEl: ".bannerSwiper .swiper-button-next",
      prevEl: ".bannerSwiper .swiper-button-prev"
    },
    effect: "fade",
    fadeEffect: { crossFade: true },
    speed: 800
  });

  // Carrusel de productos destacados
  new Swiper(".mySwiper", {
    slidesPerView: 4,
    spaceBetween: 20,
    loop: true,
    autoplay: {
      delay: 3000,
      disableOnInteraction: false
    },
    navigation: {
      nextEl: ".mySwiper .swiper-button-next",
      prevEl: ".mySwiper .swiper-button-prev"
    },
    breakpoints: {
      1024: { slidesPerView: 4 },
      768: { slidesPerView: 2 },
      480: { slidesPerView: 1 }
    }
  });

  // Lupa como √≠cono dentro del input
  const searchInput = document.getElementById("searchInput");
  const searchBox = document.getElementById("searchBox");
  const searchIcon = document.getElementById("searchIcon");
  const filterForm = document.getElementById("filterForm");

  if (searchInput && searchBox && searchIcon && filterForm) {
    const toggleSearchState = () => {
      const hasText = searchInput.value.trim().length > 0;
      searchBox.classList.toggle("active", hasText);
    };

    toggleSearchState(); // inicial
    searchInput.addEventListener("input", toggleSearchState);

    searchIcon.addEventListener("click", () => {
      if (searchInput.value.trim()) {
        filterForm.submit();
      }
    });
  }
});
</script>
{% endblock %}