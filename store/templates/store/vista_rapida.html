{% load static humanize %}

<div class="vista-rapida-contenido">
  <!-- Miniaturas -->
  <div class="miniaturas">
    {% if producto.image %}
      <img src="{{ producto.image.url }}" alt="{{ producto.name }}" class="miniatura"
           onclick="mostrarImagen('{{ producto.image.url }}')">
    {% endif %}
    {% for img in producto.images.all %}
      <img src="{{ img.image.url }}" alt="{{ producto.name }}" class="miniatura"
           onclick="mostrarImagen('{{ img.image.url }}')">
    {% endfor %}
    {% if producto.video_file or producto.video_url %}
      <div class="miniatura video-miniatura"
           onclick="mostrarVideo('{% if producto.video_file %}{{ producto.video_file.url }}{% else %}{{ producto.video_url }}{% endif %}', {% if producto.video_file %}true{% else %}false{% endif %})">
        {% if producto.video_thumb %}
          <img src="{{ producto.video_thumb.url }}" alt="Video">
        {% elif producto.image %}
          <img src="{{ producto.image.url }}" alt="Video">
        {% else %}
          <img src="{% static 'icons/video-thumb.png' %}" alt="Video">
        {% endif %}
        <div class="video-overlay"><i class="bi bi-play-circle-fill"></i></div>
      </div>
    {% endif %}
  </div>

  <!-- Imagen/Video principal -->
  <div class="imagen-principal">
    {% if producto.image %}
      <img id="imagen-principal" src="{{ producto.image.url }}" alt="{{ producto.name }}" class="big-image visible">
    {% else %}
      <img id="imagen-principal" src="{% static 'icons/no-image.png' %}" alt="{{ producto.name }}" class="big-image visible">
    {% endif %}

    <div id="video-contenedor" class="video-container hidden">
      <video id="video-file" controls class="video-el">
        <source id="video-source" src="" type="video/mp4">
        Tu navegador no soporta video HTML5.
      </video>
      <iframe id="video-frame" frameborder="0" allowfullscreen class="iframe-el"></iframe>
    </div>
  </div>

  <!-- Informaci√≥n del producto -->
  <div class="info-producto">
    <h3>{{ producto.name }}</h3>
    <p>{{ producto.description }}</p>

    {% if producto.discount > 0 %}
      <p class="text-danger fw-bold">Precio con descuento: ${{ producto.final_price|intcomma }}</p>
      <p class="text-muted text-decoration-line-through">Antes: ${{ producto.cost|intcomma }}</p>
      <span class="badge bg-success">-{{ producto.discount }}%</span>
    {% else %}
      <p class="fw-bold">Precio: ${{ producto.cost|intcomma }}</p>
    {% endif %}

    {% if producto.talla_list %}
      <div class="mb-3">
        <label>Tallas:</label>
        <div class="d-flex flex-wrap gap-2">
          {% for talla in producto.talla_list %}
            <label class="option-chip" for="talla-{{ forloop.counter }}">
              <input id="talla-{{ forloop.counter }}" type="radio" name="selected_size" value="{{ talla }}" class="visually-hidden">
              <span>{{ talla }}</span>
            </label>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if producto.colors_list %}
      <div class="mb-3">
        <label>Colores:</label>
        <div class="d-flex flex-wrap gap-2">
          {% for color in producto.colors_list %}
            <label class="option-chip" for="color-{{ forloop.counter }}">
              <input id="color-{{ forloop.counter }}" type="radio" name="selected_color" value="{{ color }}" class="visually-hidden">
              <span>{{ color }}</span>
            </label>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <form method="POST" action="{% url 'store:agregar_al_carrito' producto.id %}" id="form-add-cart">
      {% csrf_token %}
      <input type="hidden" name="selected_size">
      <input type="hidden" name="selected_color">
      <input type="hidden" name="cantidad" value="1">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-cart-plus"></i> Agregar al carrito
      </button>
    </form>
  </div>
</div>

<style>
/* =========================
   üì¶ CONTENEDOR PRINCIPAL
   ========================= */
.vista-rapida-contenido {
  display: flex;
  flex-wrap: wrap;
  gap: 1.5em;
  padding: 1.5em;
  align-items: flex-start;
  justify-content: center;
}

/* =========================
   üñºÔ∏è MINIATURAS
   ========================= */
.miniaturas {
  flex: 0 0 90px;
  display: flex;
  flex-direction: column;
  gap: 0.7em;
}

.miniatura {
  width: 80px;
  cursor: pointer;
  border: 1px solid #ddd;
  border-radius: 6px;
  transition: transform .2s ease;
}

.miniatura:hover {
  transform: scale(1.05);
}

/* Miniatura de video con overlay */
.video-miniatura {
  width: 80px;
  height: 80px;
  position: relative;
  overflow: hidden;
}

.video-miniatura img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
}

.video-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0, 0, 0, 0.4);
  color: #fff;
  font-size: 1.5rem;
  border-radius: 6px;
}

/* =========================
   üñºÔ∏è IMAGEN PRINCIPAL
   ========================= */
.imagen-principal {
  flex: 1;
  min-width: 280px;
  max-width: 480px;
  text-align: center;
  position: relative;
}

.big-image {
  width: 100%;
  aspect-ratio: 1/1;
  object-fit: cover;
  border-radius: 8px;
  transition: transform 0.3s ease;
}

.big-image:hover {
  transform: scale(1.05);
}

/* =========================
   üé• VIDEO
   ========================= */
.video-container {
  position: absolute;
  inset: 0;
  background: #000;
  overflow: hidden;
  z-index: 2;
  height: 100%;
}

.video-el,
.iframe-el {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border: 0;
  border-radius: 8px;
  background: #000;
}

/* =========================
   üìÑ INFO PRODUCTO
   ========================= */
.info-producto {
  flex: 1;
  min-width: 280px;
}

/* =========================
   üé® CHIPS
   ========================= */
.option-chip {
  display: inline-flex;
  align-items: center;
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-radius: 6px;
  cursor: pointer;
}

.option-chip input {
  display: none;
}

.option-chip.selected {
  border-color: #0d6efd;
  background: #e7f1ff;
  color: #0d6efd;
}

/* =========================
   üì± RESPONSIVE
   ========================= */
@media (max-width: 768px) {
  .vista-rapida-contenido {
    flex-direction: column;
    padding: 1em;
    gap: 1em;
  }

  .miniaturas {
    flex-direction: row;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5em;
  }

  .imagen-principal {
    width: 100%;
    max-width: 100%;
  }

  .info-producto {
    width: 100%;
    text-align: center;
    padding: 0.5em;
  }

  .info-producto h3 {
    font-size: 1rem;
    margin-bottom: 0.5em;
  }

  .info-producto p {
    font-size: 0.85rem;
    line-height: 1.4;
  }

  .btn.btn-primary {
    font-size: 0.9rem;
    padding: 0.6em 1em;
  }
}

/* =========================
   üí≤ PRECIO Y DESCUENTO
   ========================= */
.text-danger {
  font-size: 1rem;
  font-weight: bold;
  color: #ef4444;
}

.text-decoration-line-through {
  font-size: 0.85rem;
  color: #999;
}

/* =========================
   üéØ Control de visibilidad
   ========================= */
.hidden {
  display: none !important;
}

.visible {
  display: block !important;
}
/* =========================
   üé• Visibilidad del video
   ========================= */
.video-container.hidden {
  display: none !important;
}

.video-container.visible {
  display: block !important;
  position: relative;
  height: auto;
}

.video-el,
.iframe-el {
  width: 100%;
  height: 100%;
  max-height: 480px;
  object-fit: cover;
  border-radius: 8px;
  background: #000;
}
</style>

<style>
/* ... tu CSS existente ... */

/* üéØ Control de visibilidad */
.hidden { display: none !important; }
.visible { display: block !important; }

/* üé• Visibilidad del video */
.video-container.hidden { display: none !important; }
.video-container.visible { display: block !important; position: relative; height: auto; }
.video-el, .iframe-el { width: 100%; height: 100%; max-height: 480px; object-fit: cover; border-radius: 8px; background: #000; }
</style>

<script>
// =========================
// üîß Funciones auxiliares
// =========================
function toggleVisibility(showVideo) {
  const img = document.getElementById('imagen-principal');
  const videoCont = document.getElementById('video-contenedor');
  if (!img || !videoCont) return;

  if (showVideo) {
    img.classList.add('hidden'); img.classList.remove('visible'); img.style.display = 'none';
    videoCont.classList.remove('hidden'); videoCont.classList.add('visible'); videoCont.style.display = 'block';
  } else {
    img.classList.remove('hidden'); img.classList.add('visible'); img.style.display = 'block';
    videoCont.classList.add('hidden'); videoCont.classList.remove('visible'); videoCont.style.display = 'none';
  }
}

// =========================
// ‚öôÔ∏è Estado inicial
// =========================
window.addEventListener('DOMContentLoaded', () => {
  toggleVisibility(false);
  const videoFile = document.getElementById('video-file');
  const videoFrame = document.getElementById('video-frame');
  if (videoFile) { videoFile.pause(); videoFile.currentTime = 0; }
  if (videoFrame) videoFrame.src = '';
});

// =========================
// üñºÔ∏è Mostrar imagen
// =========================
function mostrarImagen(url) {
  const img = document.getElementById('imagen-principal');
  const videoFile = document.getElementById('video-file');
  const videoFrame = document.getElementById('video-frame');
  if (img) img.src = url;
  toggleVisibility(false);
  if (videoFile) { videoFile.pause(); videoFile.currentTime = 0; }
  if (videoFrame) videoFrame.src = '';
}

// =========================
// üé• Mostrar video
// =========================
function mostrarVideo(src, isFile) {
  if (!src) return;
  const videoFile = document.getElementById('video-file');
  const videoSource = document.getElementById('video-source');
  const videoFrame = document.getElementById('video-frame');
  toggleVisibility(true);

  if (isFile) {
    if (videoFrame) videoFrame.src = '';
    if (videoSource) videoSource.src = src;
    if (videoFile) { videoFile.load(); videoFile.play(); }
  } else {
    if (videoFile) { videoFile.pause(); videoFile.currentTime = 0; }
    if (videoFrame) videoFrame.src = src;
  }
}

// =========================
// üéØ Sincronizaci√≥n opciones
// =========================
function syncOptions(name, logLabel) {
  document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
    radio.addEventListener('change', () => {
      const hidden = document.querySelector(`#form-add-cart input[name="${name}"]`);
      if (hidden) hidden.value = radio.value;
      document.querySelectorAll('label.option-chip').forEach(chip => chip.classList.remove('selected'));
      const chip = radio.closest('label.option-chip');
      if (chip) chip.classList.add('selected');
      console.log(`${logLabel} ${radio.value}`);
    });
  });
}

syncOptions("selected_size", "‚úÖ Talla seleccionada:");
syncOptions("selected_color", "üé® Color seleccionado:");
</script>