{% load static humanize %}

<style>
    :root {
        --azul-hermoso: #0f087e; 
        --gris-suave: #f8f9fa;
        --texto-suave: #666;
    }

    /* Contenedor Principal del Modal */
    .vista-rapida-contenido {
        display: flex;
        flex-direction: row;
        gap: 25px;
        padding: 40px;
        background: white;
        border-radius: 24px;
        position: relative;
        max-width: 950px;
        width: 95%;
        margin: auto;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }

    /* --- GALER√çA VERTICAL (IZQUIERDA) --- */
    .galeria-producto {
        display: flex !important;
        flex-direction: row !important; /* Miniaturas a la IZQUIERDA */
        gap: 15px;
        flex: 1.4; /* Le da m√°s espacio a la imagen que al texto */
        min-width: 0; /* Evita desbordamiento en flexbox */
    }

    .miniaturas-vertical {
        display: flex !important;
        flex-direction: column !important;
        gap: 12px;
        width: 85px;
        flex-shrink: 0;
    }

    .miniatura {
        width: 75px;
        height: 75px;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid #f0f0f0;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .miniatura.activa {
        border-color: var(--azul-hermoso);
        transform: scale(1.05);
    }

    .miniatura img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* --- IMAGEN PRINCIPAL (CENTRO) --- */
    .imagen-principal {
        flex-grow: 1;
        background: var(--gris-suave);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        aspect-ratio: 1 / 1.2; /* Un poco m√°s alta que ancha para ropa */
    }

    .imagen-principal img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* Muestra la prenda completa sin recortes */
    }

    /* --- INFORMACI√ìN (DERECHA) --- */
    .info-producto {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 15px;
    }

    .titulo-producto {
        font-size: 28px;
        font-weight: 800;
        color: var(--azul-hermoso);
        margin: 0;
    }

    .precio-actual {
        font-size: 32px;
        font-weight: 900;
        color: var(--azul-hermoso);
    }

    /* --- BOTONES Y CHIPS --- */
    .btn-agregar {
        margin-top: 10px;
        padding: 18px;
        border-radius: 15px;
        border: none;
        background: var(--azul-hermoso);
        color: white;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        transition: 0.3s;
    }

    .btn-agregar:hover {
        filter: brightness(1.2);
        transform: translateY(-2px);
    }

    /* --- ADAPTACI√ìN PARA M√ìVIL --- */
    @media (max-width: 768px) {
        .vista-rapida-contenido {
            flex-direction: column;
            padding: 20px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .galeria-producto {
            flex-direction: column !important; /* Miniaturas pasan ABAJO de la foto */
        }

        .miniaturas-vertical {
            flex-direction: row !important; /* Se vuelven horizontales */
            width: 100%;
            justify-content: center;
            order: 2; /* Pone las fotos debajo de la principal */
        }

        .imagen-principal {
            order: 1;
            width: 100%;
        }

        .info-producto {
            order: 3;
            text-align: center;
        }
    }

    /* Bot√≥n cerrar del modal */
    .cerrar-modal {
        position: absolute;
        top: 15px;
        right: 15px;
        background: var(--azul-hermoso);
        color: white;
        border: none;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        z-index: 10;
    }

    /* --- ESTILOS ESPEC√çFICOS PARA LOS BOTONES DE TALLA Y COLOR (CHIPS) --- */
    .option-chip {
        all: unset !important; /* Limpia el borde negro feo del Home */
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        min-width: 45px;
        height: 38px;
        padding: 0 12px;
        margin: 5px;
        background-color: white !important;
        border: 1.5px solid #ddd !important;
        border-radius: 12px !important; /* El redondeado que buscas */
        font-size: 14px !important;
        font-weight: 600 !important;
        color: #333 !important;
        cursor: pointer;
        transition: all 0.2s ease;
        box-sizing: border-box !important;
    }

    /* Estado cuando pasas el mouse */
    .option-chip:hover {
        border-color: var(--azul-hermoso) !important;
        color: var(--azul-hermoso) !important;
    }

    /* Estado SELECCIONADO (El que activa tu JavaScript) */
    .option-chip.selected {
        background-color: var(--azul-hermoso) !important;
        border-color: var(--azul-hermoso) !important;
        color: white !important;
        box-shadow: 0 4px 10px rgba(15, 8, 126, 0.3);
    }

    /* Ajuste para el contenedor de los botones */
    .opciones {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 15px;
    }
</style>


<div class="vista-rapida-contenido" data-mode="quick" id="contenidoProducto">
    <button class="cerrar-panel" onclick="cerrarVistaRapida()" aria-label="Cerrar">‚úï</button>

    <div class="galeria-producto">
        <div class="imagen-principal" id="visor-principal">
            <img src="{% if producto.image %}{{ producto.image.url }}{% else %}{% static 'icons/no-image.png' %}{% endif %}" 
                 id="imagen-principal-modal" class="big-image" alt="{{ producto.name }}">
        </div>
<div class="miniaturas-horizontal">
    {% for img in producto.images.all %}
        <div class="miniatura {% if forloop.first %}activa{% endif %}" 
                data-src="{{ img.image.url }}" 
                data-color="{{ img.color_vinculado|default:'' }}"
                style="cursor: pointer;">
            <img src="{{ img.image.url }}" alt="Vista previa" style="width: 60px; height: 60px; object-fit: cover;">
        </div>
    {% endfor %}
</div>
    </div>

    <div class="info-producto">
        <h3 class="titulo titulo-modal">{{ producto.name }}</h3>
        <p class="descripcion text-muted small">{{ producto.description|truncatewords:20 }}</p>

        <div class="precio mb-3">
            <span class="precio-final" style="font-size: 1.8rem; color: var(--azul-hermoso); font-weight: 900;">
                ${{ producto.final_price|floatformat:0|intcomma }}
            </span>
            {% if producto.discount > 0 %}
                <span class="precio-original text-decoration-line-through ms-2 text-muted small">
                    ${{ producto.cost|floatformat:0|intcomma }}
                </span>
            {% endif %}
        </div>

        {% if talla_list %}
        <div class="bloque-opciones mb-3">
            <label class="fw-bold small d-block mb-2 text-uppercase">Talla</label>
            <div class="opciones d-flex flex-wrap" id="contenedor-tallas">
                {% for talla in talla_list %}
                    {% if talla and talla|lower != "none" and talla|lower != "null" %}
                        <button type="button" class="option-chip size-chip" data-value="{{ talla }}">{{ talla }}</button>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if color_list %}
        <div class="bloque-opciones mb-4">
            <label class="fw-bold small d-block mb-2 text-uppercase">Color</label>
            <div class="opciones d-flex flex-wrap" id="contenedor-colores">
                {% for color in color_list %}
                    <button type="button" class="option-chip color-chip" data-value="{{ color }}">{{ color }}</button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <form id="form-add-cart-modal">
            {% csrf_token %}
            <input type="hidden" name="imagen_seleccionada_url" id="imagen_seleccionada_url" value="{{ producto.image.url }}">
            <input type="hidden" name="talla" id="selected_size_hidden" value="">
            <input type="hidden" name="color" id="selected_color_hidden" value="">
            <input type="hidden" name="cantidad" value="1">

<button type="button" 
        id="btnAgregarModalPropio" 
        class="btn-agregar" 
        data-id="{{ producto.id }}" 
        disabled>
    üõí SELECCIONA OPCIONES
</button>
        </form>
    </div>
</div>

<script>
(function() {
    // Referencia al contenedor √∫nico de este producto
    const contenedor = document.getElementById('contenidoProducto') || document.querySelector('.vista-rapida-contenido');
    if (!contenedor) return;

    // Normalizaci√≥n para que "Caf√©" coincida con "cafe" o "Cafe "
    const normalizar = (t) => t ? t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";

    function validar() {
        const inputTalla = contenedor.querySelector('#selected_size_hidden');
        const inputColor = contenedor.querySelector('#selected_color_hidden');
        const btnAgregar = contenedor.querySelector('#btnAgregarModalPropio');

        const tieneTallas = contenedor.querySelectorAll('.size-chip').length > 0;
        const tallaOk = !tieneTallas || (inputTalla && inputTalla.value !== "");
        const colorOk = (inputColor && inputColor.value !== "");

        if (btnAgregar) {
            if (tallaOk && colorOk) {
                btnAgregar.disabled = false;
                btnAgregar.innerHTML = "üõí AGREGAR AL CARRITO";
            } else {
                btnAgregar.disabled = true;
                btnAgregar.innerHTML = !colorOk ? "üõí ELIGE COLOR" : "üõí ELIGE TALLA";
            }
        }
    }

    // Listener √∫nico con delegaci√≥n de eventos
    contenedor.onclick = function(e) {
        const target = e.target;

        // 1. L√≥gica de selecci√≥n de COLOR
        if (target.classList.contains('color-chip')) {
            const colorSeleccionado = target.dataset.value;
            console.log("üé® Color clickeado:", colorSeleccionado);

            // Actualizar UI de botones
            contenedor.querySelectorAll('.color-chip').forEach(b => b.classList.remove('selected'));
            target.classList.add('selected');

            // Guardar valor en el input hidden
            const inputC = contenedor.querySelector('#selected_color_hidden');
            if (inputC) inputC.value = colorSeleccionado;

            // Buscar miniatura asociada al color
            const buscado = normalizar(colorSeleccionado);
            const miniaturas = contenedor.querySelectorAll('.miniatura');
            let coincidencia = Array.from(miniaturas).find(m => normalizar(m.dataset.color) === buscado);

            if (coincidencia) {
                console.log("‚úÖ Miniatura encontrada para color:", coincidencia.dataset.src);
                coincidencia.click(); // Simular clic en la miniatura
            } else {
                console.warn("‚ö†Ô∏è No se encontr√≥ miniatura para el color:", colorSeleccionado);
            }
            validar();
        }

        // 2. L√≥gica de selecci√≥n de TALLA
        if (target.classList.contains('size-chip')) {
            contenedor.querySelectorAll('.size-chip').forEach(b => b.classList.remove('selected'));
            target.classList.add('selected');
            const inputT = contenedor.querySelector('#selected_size_hidden');
            if (inputT) inputT.value = target.dataset.value;
            console.log("üëü Talla seleccionada:", target.dataset.value);
            validar();
        }

        // 3. L√≥gica al dar clic directamente en una MINIATURA
        const mini = target.closest('.miniatura');
        if (mini) {
            const imgP = contenedor.querySelector('#imagen-principal-modal');
            if (imgP) {
                imgP.src = mini.dataset.src;
                console.log("üñº Imagen principal cambiada a:", mini.dataset.src);
                const inputImg = contenedor.querySelector('#imagen_seleccionada_url');
                if (inputImg) inputImg.value = mini.dataset.src;
            }

            contenedor.querySelectorAll('.miniatura').forEach(m => m.classList.remove('activa'));
            mini.classList.add('activa');

            // Si la miniatura tiene color, marcar el bot√≥n de color correspondiente
            const colorDeFoto = normalizar(mini.dataset.color);
            if (colorDeFoto) {
                const btnCorrespondiente = Array.from(contenedor.querySelectorAll('.color-chip'))
                    .find(btn => normalizar(btn.dataset.value) === colorDeFoto);

                if (btnCorrespondiente) {
                    contenedor.querySelectorAll('.color-chip').forEach(b => b.classList.remove('selected'));
                    btnCorrespondiente.classList.add('selected');
                    const inputC = contenedor.querySelector('#selected_color_hidden');
                    if (inputC) inputC.value = btnCorrespondiente.dataset.value;
                    console.log("üîó Bot√≥n de color sincronizado con miniatura:", btnCorrespondiente.dataset.value);
                }
            }
            validar();
        }
    };

    // Auto-selecci√≥n: al abrir, clickeamos el primer color para inicializar la vista
    setTimeout(() => {
        const primerColor = contenedor.querySelector('.color-chip');
        if (primerColor) primerColor.click();
    }, 400);

})();
</script>
