{% load static humanize %}

<style>
    :root {
        --azul-hermoso: #0f087e; /* Tu azul exacto [cite: 2026-01-26] */
        --azul-brillante: #3949ab;
    }

    .option-chip {
        border: 2px solid #dce0e4;
        background: white;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        font-weight: 600;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .option-chip:hover { 
        border-color: var(--azul-hermoso); 
        color: var(--azul-hermoso);
        transform: translateY(-1px);
    }
    
    .option-chip.selected {
        background-color: var(--azul-hermoso) !important;
        color: white !important;
        border-color: var(--azul-hermoso) !important;
        box-shadow: 0 4px 10px rgba(15, 8, 126, 0.3);
    }

    .btn-agregar {
        width: 100%;
        padding: 15px;
        border-radius: 50px;
        border: none;
        background-color: var(--azul-hermoso);
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
        transition: all 0.3s;
        margin-top: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .btn-agregar:hover:not(:disabled) {
        background-color: var(--azul-brillante);
        box-shadow: 0 6px 15px rgba(15, 8, 126, 0.4);
        transform: translateY(-2px);
    }

    .btn-agregar:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .miniatura.activa { 
        border: 2px solid var(--azul-hermoso) !important;
        box-shadow: 0 0 8px rgba(15, 8, 126, 0.2);
    }

    .titulo-modal {
        color: var(--azul-hermoso);
        font-weight: 800;
        letter-spacing: -0.5px;
    }
</style>

<div class="vista-rapida-contenido" data-mode="quick" id="contenidoProducto">
    <button class="cerrar-panel" onclick="cerrarVistaRapida()" aria-label="Cerrar">âœ•</button>

    <div class="galeria-producto">
        <div class="imagen-principal" id="visor-principal">
            <img src="{% if producto.image %}{{ producto.image.url }}{% else %}{% static 'icons/no-image.png' %}{% endif %}" 
                 id="imagen-principal-modal" class="big-image" alt="{{ producto.name }}">
        </div>
<div class="miniaturas-horizontal">
    {% for img in producto.images.all %}
        <div class="miniatura {% if forloop.first %}activa{% endif %}" 
                data-src="{{ img.image.url }}" 
                data-color="{{ img.color_vinculado|default:'' }}"
                style="cursor: pointer;">
            <img src="{{ img.image.url }}" alt="Vista previa" style="width: 60px; height: 60px; object-fit: cover;">
        </div>
    {% endfor %}
</div>
    </div>

    <div class="info-producto">
        <h3 class="titulo titulo-modal">{{ producto.name }}</h3>
        <p class="descripcion text-muted small">{{ producto.description|truncatewords:20 }}</p>

        <div class="precio mb-3">
            <span class="precio-final" style="font-size: 1.8rem; color: var(--azul-hermoso); font-weight: 900;">
                ${{ producto.final_price|floatformat:0|intcomma }}
            </span>
            {% if producto.discount > 0 %}
                <span class="precio-original text-decoration-line-through ms-2 text-muted small">
                    ${{ producto.cost|floatformat:0|intcomma }}
                </span>
            {% endif %}
        </div>

        {% if talla_list %}
        <div class="bloque-opciones mb-3">
            <label class="fw-bold small d-block mb-2 text-uppercase">Talla</label>
            <div class="opciones d-flex flex-wrap" id="contenedor-tallas">
                {% for talla in talla_list %}
                    {% if talla and talla|lower != "none" and talla|lower != "null" %}
                        <button type="button" class="option-chip size-chip" data-value="{{ talla }}">{{ talla }}</button>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if color_list %}
        <div class="bloque-opciones mb-4">
            <label class="fw-bold small d-block mb-2 text-uppercase">Color</label>
            <div class="opciones d-flex flex-wrap" id="contenedor-colores">
                {% for color in color_list %}
                    <button type="button" class="option-chip color-chip" data-value="{{ color }}">{{ color }}</button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <form id="form-add-cart-modal">
            {% csrf_token %}
            <input type="hidden" name="imagen_seleccionada_url" id="imagen_seleccionada_url" value="{{ producto.image.url }}">
            <input type="hidden" name="talla" id="selected_size_hidden" value="">
            <input type="hidden" name="color" id="selected_color_hidden" value="">
            <input type="hidden" name="cantidad" value="1">

<button type="button" 
        id="btnAgregarModalPropio" 
        class="btn-agregar" 
        data-id="{{ producto.id }}" 
        disabled>
    ðŸ›’ SELECCIONA OPCIONES
</button>
        </form>
    </div>
</div>

<script>
(function() {
    // Referencia al contenedor Ãºnico de este producto
    const contenedor = document.getElementById('contenidoProducto') || document.querySelector('.vista-rapida-contenido');
    if (!contenedor) return;

    // NormalizaciÃ³n para que "CafÃ©" coincida con "cafe" o "Cafe "
    const normalizar = (t) => t ? t.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";

    function validar() {
        const inputTalla = contenedor.querySelector('#selected_size_hidden');
        const inputColor = contenedor.querySelector('#selected_color_hidden');
        const btnAgregar = contenedor.querySelector('#btnAgregarModalPropio');

        const tieneTallas = contenedor.querySelectorAll('.size-chip').length > 0;
        const tallaOk = !tieneTallas || (inputTalla && inputTalla.value !== "");
        const colorOk = (inputColor && inputColor.value !== "");

        if (btnAgregar) {
            if (tallaOk && colorOk) {
                btnAgregar.disabled = false;
                btnAgregar.innerHTML = "ðŸ›’ AGREGAR AL CARRITO";
            } else {
                btnAgregar.disabled = true;
                btnAgregar.innerHTML = !colorOk ? "ðŸ›’ ELIGE COLOR" : "ðŸ›’ ELIGE TALLA";
            }
        }
    }

    // Listener Ãºnico con delegaciÃ³n de eventos
    contenedor.onclick = function(e) {
        const target = e.target;

        // 1. LÃ³gica de selecciÃ³n de COLOR
        if (target.classList.contains('color-chip')) {
            const colorSeleccionado = target.dataset.value;
            console.log("ðŸŽ¨ Color clickeado:", colorSeleccionado);

            // Actualizar UI de botones
            contenedor.querySelectorAll('.color-chip').forEach(b => b.classList.remove('selected'));
            target.classList.add('selected');

            // Guardar valor en el input hidden
            const inputC = contenedor.querySelector('#selected_color_hidden');
            if (inputC) inputC.value = colorSeleccionado;

            // Buscar miniatura asociada al color
            const buscado = normalizar(colorSeleccionado);
            const miniaturas = contenedor.querySelectorAll('.miniatura');
            let coincidencia = Array.from(miniaturas).find(m => normalizar(m.dataset.color) === buscado);

            if (coincidencia) {
                console.log("âœ… Miniatura encontrada para color:", coincidencia.dataset.src);
                coincidencia.click(); // Simular clic en la miniatura
            } else {
                console.warn("âš ï¸ No se encontrÃ³ miniatura para el color:", colorSeleccionado);
            }
            validar();
        }

        // 2. LÃ³gica de selecciÃ³n de TALLA
        if (target.classList.contains('size-chip')) {
            contenedor.querySelectorAll('.size-chip').forEach(b => b.classList.remove('selected'));
            target.classList.add('selected');
            const inputT = contenedor.querySelector('#selected_size_hidden');
            if (inputT) inputT.value = target.dataset.value;
            console.log("ðŸ‘Ÿ Talla seleccionada:", target.dataset.value);
            validar();
        }

        // 3. LÃ³gica al dar clic directamente en una MINIATURA
        const mini = target.closest('.miniatura');
        if (mini) {
            const imgP = contenedor.querySelector('#imagen-principal-modal');
            if (imgP) {
                imgP.src = mini.dataset.src;
                console.log("ðŸ–¼ Imagen principal cambiada a:", mini.dataset.src);
                const inputImg = contenedor.querySelector('#imagen_seleccionada_url');
                if (inputImg) inputImg.value = mini.dataset.src;
            }

            contenedor.querySelectorAll('.miniatura').forEach(m => m.classList.remove('activa'));
            mini.classList.add('activa');

            // Si la miniatura tiene color, marcar el botÃ³n de color correspondiente
            const colorDeFoto = normalizar(mini.dataset.color);
            if (colorDeFoto) {
                const btnCorrespondiente = Array.from(contenedor.querySelectorAll('.color-chip'))
                    .find(btn => normalizar(btn.dataset.value) === colorDeFoto);

                if (btnCorrespondiente) {
                    contenedor.querySelectorAll('.color-chip').forEach(b => b.classList.remove('selected'));
                    btnCorrespondiente.classList.add('selected');
                    const inputC = contenedor.querySelector('#selected_color_hidden');
                    if (inputC) inputC.value = btnCorrespondiente.dataset.value;
                    console.log("ðŸ”— BotÃ³n de color sincronizado con miniatura:", btnCorrespondiente.dataset.value);
                }
            }
            validar();
        }
    };

    // Auto-selecciÃ³n: al abrir, clickeamos el primer color para inicializar la vista
    setTimeout(() => {
        const primerColor = contenedor.querySelector('.color-chip');
        if (primerColor) primerColor.click();
    }, 400);

})();
</script>
