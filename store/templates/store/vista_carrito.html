{% load static %}
<div class="carrito-galeria p-3" id="contenidoProducto">
    <div class="imagen-principal text-center mb-3">
        <div class="marco-premium shadow-sm rounded bg-white">
            <img src="{% if producto.image %}{{ producto.image.url }}{% else %}{% static 'imgs/default-product.jpg' %}{% endif %}"
                 class="img-fluid" id="imagen-principal-modal" 
                 style="max-height: 250px; width: 100%; object-fit: contain; padding: 10px;">
        </div>
    </div>

    <div class="miniaturas-abajo d-flex justify-content-center gap-2 mb-3 flex-wrap">
        {% for img in producto.images.all %}
        <div class="miniatura {% if forloop.first %}activa-azul{% endif %}" 
             data-src="{{ img.image.url }}" 
             data-color="{{ img.color_vinculado|default:'' }}" 
             style="width: 55px; height: 55px; cursor: pointer; border: 2px solid {% if forloop.first %}#0f087e{% else %}#ddd{% endif %}; border-radius: 6px; overflow: hidden;">
            <img src="{{ img.image.url }}" style="width: 100%; height: 100%; object-fit: cover;">
        </div>
        {% endfor %}
    </div>

    <div class="text-center mb-3">
        <h6 class="fw-bold mb-1" style="color: #333; font-size: 1.1rem;">{{ producto.name }}</h6>
        <div class="d-flex justify-content-center align-items-center gap-2">
            <span class="precio-final h3 fw-bold" style="color: #0f087e; font-size: 2.2rem; font-weight: 900;">
                $ {{ producto.final_price|floatformat:0 }}
            </span>
        </div>
    </div>

    <form id="form-add-cart-modal"> 
        {% csrf_token %}
        <input type="hidden" name="talla" id="selected_size_hidden" value="">
        <input type="hidden" name="color" id="selected_color_hidden" value="">
        <input type="hidden" name="imagen_seleccionada_url" id="imagen_seleccionada_url" value="{% if producto.image %}{{ producto.image.url }}{% endif %}">
        <input type="hidden" name="cantidad" value="1">

        {% if producto.talla_list %}
        <div class="mb-3">
            <label class="fw-bold small d-block mb-1 text-muted">TALLA:</label>
            <div class="d-flex gap-2 flex-wrap" id="modal-tallas">
                {% for talla in producto.talla_list %}
                <button type="button" class="option-chip size-chip btn btn-sm btn-outline-dark" data-value="{{ talla }}">{{ talla }}</button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if producto.color_list %}
        <div class="mb-3">
            <label class="fw-bold small d-block mb-1 text-muted">COLOR:</label>
            <div class="d-flex gap-2 flex-wrap" id="modal-colores">
                {% for color in producto.color_list %}
                <button type="button" class="option-chip color-chip btn btn-sm btn-outline-dark" data-value="{{ color }}">{{ color }}</button>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <button type="button" id="btnAgregarModal" data-id="{{ producto.id }}"
                class="btn w-100 py-3 fw-bold text-white shadow-sm" disabled 
                style="background-color: #0f087e; border: none; border-radius: 50px; opacity: 0.5;">
            CONFIRMAR SELECCIÓN
        </button>
    </form>
</div>

<style>
    /* Estilo para tu Azul Hermoso */
    .option-chip.active {
        background-color: #0f087e !important;
        color: white !important;
        border-color: #0f087e !important;
        opacity: 1 !important;
    }
    /* Quitamos el pointer-events: none que bloqueaba la activación */
    .color-chip { 
        cursor: default; 
        opacity: 0.7; 
        transition: all 0.3s ease;
    }
</style>

<script>
(function() {
    const ID_CONTENEDOR = 'contenidoProducto';
    
    function inicializarLogica() {
        const contenedor = document.getElementById(ID_CONTENEDOR);
        if (!contenedor) return;

        const inputColor = contenedor.querySelector('#selected_color_hidden');
        const inputTalla = contenedor.querySelector('#selected_size_hidden');
        const btnAgregar = contenedor.querySelector('#btnAgregarModal');

        function seleccionarColor(valor) {
            if (!valor) return;
            const chips = contenedor.querySelectorAll('.color-chip');
            const valorBusqueda = valor.trim().toLowerCase();

            chips.forEach(chip => {
                chip.classList.remove('active');
                const chipValor = chip.getAttribute('data-value').trim().toLowerCase();
                
                // Comparación flexible: ayuda si uno dice "Beis" y otro "Beige" o tiene espacios
                if (chipValor === valorBusqueda || chipValor.includes(valorBusqueda) || valorBusqueda.includes(chipValor)) {
                    chip.classList.add('active');
                    if(inputColor) inputColor.value = chip.getAttribute('data-value');
                }
            });
            validarForm();
        }

        function validarForm() {
            const colorOk = inputColor && inputColor.value !== "";
            const tallaOk = !contenedor.querySelector('.size-chip') || (inputTalla && inputTalla.value !== "");
            
            if (colorOk && tallaOk && btnAgregar) {
                btnAgregar.disabled = false;
                btnAgregar.style.opacity = "1";
                btnAgregar.innerHTML = "AGREGAR AL CARRITO";
            }
        }

        // Evento para Miniaturas
        contenedor.querySelectorAll('.miniatura').forEach(thumb => {
            thumb.addEventListener('click', function() {
                const color = this.getAttribute('data-color');
                const src = this.getAttribute('data-src');
                
                // Cambiar imagen principal
                const imgPri = contenedor.querySelector('#imagen-principal-modal');
                if(imgPri) imgPri.src = src;

                // Marcar borde de miniatura
                contenedor.querySelectorAll('.miniatura').forEach(m => m.style.borderColor = '#ddd');
                this.style.borderColor = '#0f087e';

                seleccionarColor(color);
            });
        });

        // Evento para Tallas
        contenedor.querySelectorAll('.size-chip').forEach(btn => {
            btn.onclick = function() {
                contenedor.querySelectorAll('.size-chip').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                inputTalla.value = this.getAttribute('data-value');
                validarForm();
            };
        });

        // --- ACTIVACIÓN AUTOMÁTICA FORZADA ---
        setTimeout(() => {
            const primeraMini = contenedor.querySelector('.miniatura');
            if (primeraMini) {
                console.log("Forzando activación inicial...");
                primeraMini.click();
            }
        }, 300); // Damos tiempo al modal para estabilizarse
    }

    // Observador para detectar el modal
    const observer = new MutationObserver(() => {
        if (document.getElementById(ID_CONTENEDOR)) {
            inicializarLogica();
            observer.disconnect();
        }
    });
    observer.observe(document.body, { childList: true, subtree: true });
})();
</script>