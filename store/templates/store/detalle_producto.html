{% extends 'base.html' %}
{% load static %}

{% block title %}{{ producto.name }} | JascStore{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row g-4">

    <div class="col-md-6">
      <div id="imagen-principal" class="imagen-principal mb-3 text-center">
        {% if producto.image %}
          <img src="{{ producto.image.url }}" class="img-fluid rounded shadow" style="max-height: 500px;" id="main-view">
        {% else %}
          <img src="{% static 'img/no-image.png' %}" class="img-fluid rounded shadow" style="max-height: 500px;">
        {% endif %}
      </div>

      <div class="d-flex gap-2 justify-content-center flex-wrap mt-3">
        {% if producto.image %}
          <img src="{{ producto.image.url }}"
               class="miniatura activa activa-azul"
               data-type="image"
               data-src="{{ producto.image.url }}"
               data-color="" 
               style="width: 70px; height: 70px; object-fit: cover; cursor: pointer; border-radius: 5px; border: 2px solid #ddd;">
        {% endif %}

        {% for img in producto.images.all %}
          <img src="{{ img.image.url }}"
               class="miniatura"
               data-type="image"
               data-src="{{ img.image.url }}"
               data-color="{{ img.color_vinculado|default:'' }}"
               style="width: 70px; height: 70px; object-fit: cover; cursor: pointer; border-radius: 5px; border: 2px solid #ddd;">
        {% endfor %}

        {% if producto.video_file %}
          <img src="{{ producto.video_thumb.url }}"
               class="miniatura"
               data-type="video"
               data-src="{{ producto.video_file.url }}"
               data-poster="{{ producto.video_thumb.url }}"
               style="width: 70px; height: 70px; object-fit: cover; cursor: pointer; border-radius: 5px; border: 2px solid #ddd;">
        {% endif %}

        {% if producto.video_url %}
          <img src="{{ producto.video_thumb.url }}"
               class="miniatura"
               data-type="video"
               data-src="{{ producto.video_url }}"
               data-poster="{{ producto.video_thumb.url }}"
               style="width: 70px; height: 70px; object-fit: cover; cursor: pointer; border-radius: 5px; border: 2px solid #ddd;">
        {% endif %}
      </div>
    </div>

    <div class="col-md-6">
      <h2 class="fw-bold" style="color: var(--azul-hermoso);">{{ producto.name }}</h2>
      <p class="text-muted">{{ producto.description }}</p>

      <div class="precios mb-4">
        {% if producto.discount > 0 %}
          <span class="fs-3 text-danger fw-bold">${{ producto.final_price|floatformat:0 }}</span>
          <span class="text-muted text-decoration-line-through ms-2">${{ producto.cost|floatformat:0 }}</span>
          <span class="badge bg-danger ms-2">-{{ producto.discount }}%</span>
        {% else %}
          <span class="fs-3 fw-bold" style="color: var(--azul-hermoso);">${{ producto.cost|floatformat:0 }}</span>
        {% endif %}
      </div>

      <form method="POST"
            action="{% url 'store:agregar_al_carrito' producto.id %}"
            id="form-add-cart"
            data-product-id="{{ producto.id }}">
        {% csrf_token %}

        {% if producto.talla_list %}
        <div class="mb-4">
          <label class="fw-bold d-block mb-2">Tallas:</label>
          <div class="d-flex gap-2 flex-wrap">
            {% for talla in producto.talla_list %}
            <label class="option-chip size-chip">
              <input type="radio"
                     name="selected_size"
                     value="{{ talla }}"
                     class="visually-hidden">
              <span class="btn btn-outline-secondary size-btn">{{ talla }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if producto.color_visual_list %}
        <div class="mb-4">
          <label class="fw-bold d-block mb-2">Colores:</label>
          <div class="d-flex gap-2 flex-wrap">
            {% for color in producto.color_visual_list %}
              <label class="option-chip color-chip">
                <input type="radio"
                      name="selected_color"
                      value="{{ color.nombre }}"
                      class="visually-hidden">
                <span class="color-indicator" 
                      style="background-color: {{ color.css }}; 
                             padding: 8px 15px; 
                             border-radius: 20px; 
                             display: inline-block; 
                             cursor: pointer; 
                             border: 2px solid #ddd;
                             color: {% if color.nombre == 'Blanco' or color.css == '#ffffff' %}#000{% else %}#fff{% endif %};">
                  {{ color.nombre }}
                </span>
              </label>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <input type="hidden" name="selected_size_hidden" id="selected_size_hidden">
        <input type="hidden" name="selected_color_hidden" id="selected_color_hidden">
        <input type="hidden" name="cantidad" value="1">

        <div class="d-grid gap-2">
            <button type="submit"
                    class="btn btn-lg mt-3 btn-agregar text-white"
                    id="btn-add-main"
                    style="background-color: var(--azul-hermoso); border: none;"
                    disabled>
              <i class="bi bi-cart-plus"></i> Agregar al carrito
            </button>
        </div>
      </form>
    </div>

  </div>
</div>

<style>
/* Variables de color */
:root {
    --azul-hermoso: #1a237e;
    --azul-brillante: #3949ab;
}

/* Efecto de selección para miniaturas */
.miniatura.activa-azul {
    border: 3px solid var(--azul-hermoso) !important;
    box-shadow: 0 0 10px rgba(26, 35, 126, 0.5);
    transform: scale(1.05);
}

/* Efecto visual cuando se selecciona una talla o color */
input[type="radio"]:checked + span {
    border-color: var(--azul-hermoso) !important;
    background-color: var(--azul-hermoso) !important;
    color: #fff !important;
    box-shadow: 0 0 5px rgba(26, 35, 126, 0.5);
}

.size-btn {
    min-width: 45px;
    text-align: center;
    transition: 0.3s;
}

/* Estado deshabilitado del botón */
#btn-add-main:disabled {
    background-color: #cccccc !important;
    cursor: not-allowed;
    opacity: 0.6;
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/store.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('form-add-cart');
    const btnAdd = document.getElementById('btn-add-main');
    const sizeRadios = document.querySelectorAll('input[name="selected_size"]');
    const colorRadios = document.querySelectorAll('input[name="selected_color"]');
    const sizeHidden = document.getElementById('selected_size_hidden');
    const colorHidden = document.getElementById('selected_color_hidden');

    function checkValidity() {
        const sizeSelected = Array.from(sizeRadios).some(r => r.checked) || sizeRadios.length === 0;
        const colorSelected = Array.from(colorRadios).some(r => r.checked) || colorRadios.length === 0;

        if (sizeSelected && colorSelected) {
            btnAdd.disabled = false;
            btnAdd.innerHTML = '<i class="bi bi-cart-check-fill"></i> ¡Listo para añadir!';
        }
    }

    sizeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            sizeHidden.value = e.target.value;
            checkValidity();
        });
    });

    colorRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            colorHidden.value = e.target.value;
            checkValidity();
        });
    });

    // Manejo de cambio de imagen principal al hacer clic en miniaturas
    document.querySelectorAll('.miniatura').forEach(thumb => {
        thumb.addEventListener('click', function() {
            const mainImg = document.getElementById('main-view');
            if (this.dataset.type === 'image') {
                mainImg.src = this.dataset.src;
            }
            // Quitar clase activa de todas y poner a esta
            document.querySelectorAll('.miniatura').forEach(m => m.classList.remove('activa-azul'));
            this.classList.add('activa-azul');
        });
    });
});
</script>
{% endblock %}