{% extends 'base.html' %}
{% load static %}

{% block title %}{{ producto.name }} | JascStore{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row g-4">

    <div class="col-md-6">
      <div id="contenedor-principal" class="mb-3 text-center bg-light rounded shadow-sm p-2" style="min-height: 400px; display: flex; align-items: center; justify-content: center;">
        {% if producto.image %}
          <img src="{{ producto.image.url }}" class="img-fluid rounded" style="max-height: 500px; object-fit: contain;" id="main-view">
        {% else %}
          <img src="{% static 'img/no-image.png' %}" class="img-fluid rounded" style="max-height: 500px;">
        {% endif %}
      </div>

      <div class="d-flex gap-2 justify-content-center flex-wrap mt-3">
        {% if producto.image %}
          <img src="{{ producto.image.url }}"
               class="miniatura activa-azul"
               data-type="image"
               data-src="{{ producto.image.url }}"
               data-color="General" 
               style="width: 75px; height: 75px; object-fit: cover; cursor: pointer; border-radius: 8px; border: 2px solid #eee;">
        {% endif %}

        {% for img in producto.images.all %}
          <img src="{{ img.image.url }}"
               class="miniatura"
               data-type="image"
               data-src="{{ img.image.url }}"
               data-color="{{ img.color_vinculado|default:'' }}"
               title="{{ img.color_vinculado }}"
               style="width: 75px; height: 75px; object-fit: cover; cursor: pointer; border-radius: 8px; border: 2px solid #eee;">
        {% endfor %}

        {% if producto.video_file %}
          <div class="miniatura position-relative" data-type="video" data-src="{{ producto.video_file.url }}" style="width: 75px; height: 75px; cursor: pointer;">
            <img src="{{ producto.video_thumb.url }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 2px solid #eee;">
            <i class="bi bi-play-circle-fill position-absolute top-50 start-50 translate-middle text-white fs-4"></i>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="col-md-6">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Inicio</a></li>
          <li class="breadcrumb-item active">{{ producto.category.name }}</li>
        </ol>
      </nav>

      <h2 class="fw-bold" style="color: #1a237e;">{{ producto.name }}</h2>
      
      <div class="precios mb-3">
        {% if producto.discount > 0 %}
          <div class="d-flex align-items-center gap-2">
            <span class="fs-2 fw-bold text-danger">${{ producto.final_price|floatformat:0 }}</span>
            <span class="text-muted text-decoration-line-through">${{ producto.cost|floatformat:0 }}</span>
            <span class="badge bg-danger">OFERTA -{{ producto.discount }}%</span>
          </div>
        {% else %}
          <span class="fs-2 fw-bold" style="color: #1a237e;">${{ producto.cost|floatformat:0 }}</span>
        {% endif %}
      </div>

      <hr>

      <form method="POST" action="{% url 'store:agregar_al_carrito' producto.id %}" id="form-add-cart">
        {% csrf_token %}

        {% if producto.talla_list %}
        <div class="mb-4">
          <label class="fw-bold mb-2">Selecciona tu Talla:</label>
          <div class="d-flex gap-2 flex-wrap">
            {% for talla in producto.talla_list %}
            <label class="size-option">
              <input type="radio" name="selected_size" value="{{ talla }}" class="visually-hidden" required>
              <span class="btn btn-outline-dark px-3 py-2">{{ talla }}</span>
            </label>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        {% if producto.color_list %}
{% if producto.color_list %}
<div class="mb-4">
  <label class="fw-bold mb-2">Color seleccionado: <span id="nombre-color-display" class="text-white badge" style="background-color: #1a237e;">Ninguno</span></label>
  <div class="d-flex gap-2 flex-wrap">
    {% for color in producto.color_list %}
      <label class="color-option" style="pointer-events: none; opacity: 0.6;" id="wrapper-color-{{ color|slugify }}">
        <input type="radio" 
               name="selected_color" 
               value="{{ color }}" 
               class="visually-hidden" 
               disabled> <span class="btn btn-sm btn-outline-secondary px-3 rounded-pill">{{ color }}</span>
      </label>
    {% endfor %}
  </div>
  <small class="text-muted d-block mt-1">Elige el color tocando la foto del producto.</small>
</div>
{% endif %}

        <input type="hidden" name="cantidad" value="1">

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-lg text-white shadow-sm" id="btn-add-main" 
                    style="background-color: #1a237e; border-radius: 50px; padding: 15px;" disabled>
              <i class="bi bi-cart-plus-fill me-2"></i> AGREGAR AL CARRITO
            </button>
            <p class="text-center text-muted mt-2" style="font-size: 0.8rem;">
              <i class="bi bi-shield-check"></i> Pago seguro y Garantía JascStore
            </p>
        </div>
      </form>
    </div>

  </div>
</div>

<style>
/* Tu Azul Hermoso como variable */
:root { --jasc-azul: #1a237e; }

/* Miniaturas */
.miniatura { transition: all 0.2s ease; }
.miniatura:hover { transform: translateY(-3px); border-color: #ccc !important; }
.miniatura.activa-azul { 
    border: 3px solid var(--jasc-azul) !important; 
    box-shadow: 0 4px 10px rgba(26,35,126,0.3);
}

/* Botones de opción (Radio Buttons) */
input[type="radio"]:checked + span {
    background-color: var(--jasc-azul) !important;
    color: white !important;
    border-color: var(--jasc-azul) !important;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

#btn-add-main:disabled {
    background-color: #b0bec5 !important;
    opacity: 0.7;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnAdd = document.getElementById('btn-add-main');
    const colorRadios = document.querySelectorAll('input[name="selected_color"]');
    const sizeRadios = document.querySelectorAll('input[name="selected_size"]');
    const colorLabel = document.getElementById('nombre-color-display');

    // Función para validar si el botón de compra se activa
    function validarFormulario() {
        const sizeOk = sizeRadios.length === 0 || Array.from(sizeRadios).some(r => r.checked);
        const colorOk = colorRadios.length === 0 || Array.from(colorRadios).some(r => r.checked);
        btnAdd.disabled = !(sizeOk && colorOk);
    }

    // Al hacer clic en una miniatura
    document.querySelectorAll('.miniatura').forEach(thumb => {
        thumb.addEventListener('click', function() {
            const type = this.dataset.type;
            const src = this.dataset.src;
            const colorAsociado = this.dataset.color;
            const display = document.getElementById('contenedor-principal');

            // 1. Cambiar contenido principal (Imagen o Video)
            if (type === 'video') {
                display.innerHTML = `<video controls autoplay muted class="img-fluid rounded" style="max-height:500px;"><source src="${src}" type="video/mp4"></video>`;
            } else {
                display.innerHTML = `<img src="${src}" class="img-fluid rounded" style="max-height:500px; object-fit:contain;" id="main-view">`;
            }

            // 2. Resaltar miniatura seleccionada
            document.querySelectorAll('.miniatura').forEach(m => m.classList.remove('activa-azul'));
            this.classList.add('activa-azul');

            // 3. LOGICA TEMU: Seleccionar automáticamente el botón de color
            if (colorAsociado && colorAsociado !== 'General') {
                colorRadios.forEach(radio => {
                    if (radio.value.toLowerCase().trim() === colorAsociado.toLowerCase().trim()) {
                        radio.checked = true;
                        colorLabel.textContent = colorAsociado;
                    }
                });
            }
            validarFormulario();
        });
    });

    // Escuchar cambios manuales en radios
    [...colorRadios, ...sizeRadios].forEach(input => {
        input.addEventListener('change', () => {
            if(input.name === 'selected_color') colorLabel.textContent = input.value;
            validarFormulario();
        });
    });
});
</script>
{% endblock %}