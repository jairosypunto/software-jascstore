{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container mt-5">

  <div class="text-end mb-3">
    <button onclick="imprimirFactura()" class="btn btn-primary">üñ®Ô∏è Imprimir factura</button>
  </div>

  <div id="factura">
    <h2 class="mb-4">üßæ Confirmaci√≥n de pago ‚Äì Factura #{{ factura.id }}</h2>

    <div class="mb-3">
      <p><strong>Cliente:</strong> {{ factura.usuario.first_name|default:factura.usuario.username }}</p>
      <p><strong>Email:</strong> {{ factura.usuario.email }}</p>
      <p><strong>Fecha:</strong> {{ fecha_local|date:"d/m/Y H:i" }}</p>
      <p><strong>M√©todo de pago:</strong> {{ factura.metodo_pago }}</p>
      <p><strong>Estado del pago:</strong>
        {% if factura.estado_pago == "Pendiente" %}
          <span class="text-danger">Pendiente</span>
        {% else %}
          <span class="text-success">Pagado</span>
        {% endif %}
      </p>
      {% if factura.banco %}
        <p><strong>Banco utilizado:</strong> {{ factura.banco }}</p>
      {% endif %}
      {% if factura.transaccion_id %}
        <p><strong>ID de transacci√≥n:</strong> {{ factura.transaccion_id }}</p>
      {% endif %}
    </div>

    <h4>üõç Detalles del pedido:</h4>
    <table class="table table-bordered mt-3" style="table-layout: fixed;">
      <thead class="table-light">
        <tr>
          <th style="width:40%;">Producto</th>
          <th style="width:10%; text-align:center;">Cantidad</th>
          <th style="width:30%;">Precio unitario</th>
          <th style="width:20%; text-align:right;">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        {% for item in factura.detalles.all %}
        <tr>
          <td>{{ item.producto.name }}</td>
          <td style="text-align:center; white-space: nowrap;">{{ item.cantidad }}</td>
          <td style="word-break: break-word;">
            {% if item.producto.discount > 0 %}
              <div><strong>${{ item.producto.final_price|floatformat:0|intcomma }}</strong></div>
              <div class="text-muted" style="font-size:13px;">
                Antes: ${{ item.producto.cost|floatformat:0|intcomma }}<br>
                (-{{ item.producto.discount }}%)
              </div>
            {% else %}
              ${{ item.producto.cost|floatformat:0|intcomma }}
            {% endif %}
          </td>
          <td style="text-align:right; white-space: nowrap;">${{ item.subtotal|floatformat:0|intcomma }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-end mt-4">
      <p><strong>Subtotal:</strong> ${{ subtotal|floatformat:0|intcomma }}</p>
      <p><strong>IVA (19%):</strong> ${{ iva|floatformat:0|intcomma }}</p>
      <p><strong>Ahorro total:</strong> ${{ descuento|floatformat:0|intcomma }}</p>
      <h5 class="mt-3">üíµ Total pagado: <span class="text-success fw-bold">${{ total_final|floatformat:0|intcomma }}</span></h5>
      <p class="text-muted">El descuento ya fue aplicado en los precios unitarios. Esta l√≠nea refleja el ahorro total.</p>
    </div>
  </div>

  <div class="text-center mt-4">
    <a href="{% url 'store:store' %}" class="btn btn-outline-secondary">üõç Volver a la tienda</a>
  </div>

  <script>
    function imprimirFactura() {
      const contenido = document.getElementById("factura").innerHTML;
      const ventana = window.open("", "", "width=800,height=600");
      ventana.document.write(`
        <html>
          <head>
            <title>Factura</title>
            <style>
              body { font-family: sans-serif; font-size: 12px; margin: 40px; }
              table { width: 100%; border-collapse: collapse; }
              th, td { border: 1px solid #ccc; padding: 6px; }
              th { background-color: #f2f2f2; }
            </style>
          </head>
          <body>${contenido}</body>
        </html>
      `);
      ventana.document.close();
      ventana.print();
    }
  </script>
</div>
{% endblock %}