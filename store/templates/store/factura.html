{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container mt-5">

  <div class="text-end mb-3">
    <button onclick="imprimirFactura()" class="btn btn-primary">ğŸ–¨ï¸ Imprimir factura</button>
  </div>

  <div id="factura">
    <h2 class="mb-4">ğŸ§¾ ConfirmaciÃ³n de pedido â€“ Factura #{{ factura.id }}</h2>

    <div class="mb-4 border-bottom pb-3">
      <h5 class="fw-bold text-primary">ğŸ“¦ Datos de envÃ­o</h5>
      <div class="row">
        <div class="col-md-6">
          <p class="mb-1"><strong>Nombre:</strong> {{ factura.nombre }}</p>
          <p class="mb-1"><strong>Email:</strong> {{ factura.email }}</p>
          <p class="mb-1"><strong>TelÃ©fono:</strong> {{ factura.telefono }}</p>
        </div>
        <div class="col-md-6">
          <p class="mb-1"><strong>DirecciÃ³n:</strong> {{ factura.direccion }}</p>
          <p class="mb-1"><strong>Ciudad:</strong> {{ factura.ciudad }}</p>
          <p class="mb-1"><strong>Departamento:</strong> {{ factura.departamento }}</p>
        </div>
      </div>
    </div>

    <div class="mb-4">
      <h5 class="fw-bold text-primary">ğŸ’³ InformaciÃ³n de pago</h5>
      <p class="mb-1"><strong>Fecha:</strong> {{ factura.fecha|date:"d/m/Y H:i" }}</p>
      <p class="mb-1"><strong>MÃ©todo de pago:</strong> {{ factura.metodo_pago }}</p>
      <p class="mb-1"><strong>Estado del pago:</strong>
        {% if factura.estado_pago == "Aprobado" or factura.estado_pago == "Pagado" %}
          <span class="text-success fw-bold">âœ… Aprobado</span>
        {% else %}
          <span class="text-warning fw-bold">ğŸ•’ Pendiente</span>
        {% endif %}
      </p>
    </div>

    <h4 class="mb-3">ğŸ› Detalles de tu compra:</h4>
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:40%;">Producto</th>
          <th style="width:15%; text-align:center;">Cantidad</th>
          <th style="width:25%; text-align:right;">V. Unitario</th>
          <th style="width:20%; text-align:right;">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        {# Prioridad a los detalles guardados en la base de datos #}
        {% for det in factura.detalles.all %}
        <tr>
          <td>
            <div class="fw-bold">{{ det.producto.name }}</div>
            <div class="text-muted small">
              Talla: {{ det.talla|default:"N/A" }} | Color: {{ det.color|default:"N/A" }}
            </div>
          </td>
          <td class="text-center">{{ det.cantidad }}</td>
          {# SOLUCIÃ“N AL $ VACÃO: Si no hay precio_unitario, calculamos subtotal/cantidad #}
          <td class="text-end">
            $ {{ det.subtotal|floatformat:0|intcomma }}
          </td>
          <td class="text-end fw-bold">
            $ {{ det.subtotal|floatformat:0|intcomma }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="text-end mt-4">
      <h4 class="mt-3">
        Total pagado: 
        <span class="text-primary fw-bold">
          $ {{ factura.total|floatformat:0|intcomma }}
        </span>
      </h4>
      <p class="text-muted small">Precios en Pesos Colombianos (COP).</p>
    </div>
  </div>

  <div class="text-center mt-5 mb-5">
    <a href="{% url 'store:store' %}" class="btn btn-outline-dark px-4">ğŸ› Seguir Comprando</a>
    <a href="{% url 'store:mis_facturas' %}" class="btn btn-primary px-4 ms-2">Mis Pedidos</a>
  </div>

  <script>
    function imprimirFactura() {
      const contenido = document.getElementById("factura").innerHTML;
      const ventana = window.open("", "", "width=900,height=700");
      ventana.document.write(`
        <html>
          <head>
            <title>Factura #{{ factura.id }} - JascStore</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
              body { padding: 40px; }
              .text-primary { color: #0d6efd !important; }
            </style>
          </head>
          <body onload="window.print(); window.close();">${contenido}</body>
        </html>
      `);
      ventana.document.close();
    }
  </script>
</div>
{% endblock %}